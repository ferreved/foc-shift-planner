<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOC Live Dashboard</title>
    <style>
        body { margin: 0; padding: 0; background: #f5f5f5; font-family: Arial, sans-serif; }
        .time-indicator { background: #ffebee !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .card { background: white; border-radius: 8px; padding: 20px; margin: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-group { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-break { background: #28a745; color: white; }
        .btn-meeting { background: #007bff; color: white; }
        .status-online { color: #28a745; font-weight: bold; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .time-slot { border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 5px 0; }
        .current-time { background: #fff3cd; border-color: #ffeaa7; }
        .team-section { margin: 10px 0; }
        .engineer-list { display: flex; flex-wrap: wrap; gap: 5px; margin: 5px 0; }
        .engineer-tag { background: #e3f2fd; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .break-tag { background: #fff3cd; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .meeting-tag { background: #ffebee; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIF_gb3swfMlXFa4ZY4ZsoAZSwaqmiwm4",
            authDomain: "foc-dashboard.firebaseapp.com",
            databaseURL: "https://foc-dashboard-default-rtdb.firebaseio.com",
            projectId: "foc-dashboard",
            storageBucket: "foc-dashboard.firebasestorage.app",
            messagingSenderId: "869888485796",
            appId: "1:869888485796:web:82bf668dbfdc9c17a1f931"
        };
        
        let firebaseInitialized = false;
        let database, scheduleRef, breaksRef;
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            scheduleRef = database.ref('schedule');
            breaksRef = database.ref('userInputs');
            firebaseInitialized = true;
        } catch (error) {
            firebaseInitialized = false;
        }
        
        const TIME_SLOTS = [
            { time: '07:00', label: '7:00' }, { time: '08:00', label: '8:00' }, { time: '09:00', label: '9:00' },
            { time: '10:00', label: '10:00' }, { time: '11:00', label: '11:00' }, { time: '12:00', label: '12:00' },
            { time: '13:00', label: '13:00' }, { time: '14:00', label: '14:00' }
        ];
        
        const MEETING_REASONS = ['1:1 Meeting', 'Other Meetings', 'Advocacy', 'Interview', 'Shadow', 'Project', 'Training'];
        
        let scheduleData = {};
        let userInputs = {};
        let currentTeam = 'A';
        
        function syncUserInput(data) {
            if (!firebaseInitialized) return;
            breaksRef.push(data).catch(err => console.log('Sync failed:', err));
        }
        
        function setupRealtimeSync() {
            if (!firebaseInitialized) return;
            
            // Listen to schedule changes from admin
            scheduleRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    scheduleData = data.scheduleData || {};
                    currentTeam = data.currentTeam || 'A';
                    updateDashboard();
                }
            });
            
            // Listen to user inputs (breaks/meetings)
            breaksRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    userInputs = data;
                    updateDashboard();
                }
            });
        }
        
        function initDashboard() {
            setupRealtimeSync();
            document.getElementById('app').innerHTML = `
                <div style="margin: 20px;">
                    <h1 style="color: #232F3E; text-align: center;">FOC Live Dashboard</h1>
                    
                    <!-- User Input Section -->
                    <div class="card">
                        <h3 style="margin-top: 0;">Add Your Break or Meeting</h3>
                        <div class="input-group">
                            <input type="text" id="user-alias" placeholder="Your alias" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <select id="time-slot" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select Time Slot</option>
                                ${TIME_SLOTS.map(slot => `<option value="${slot.time}">${slot.label}</option>`).join('')}
                            </select>
                        </div>
                        <div class="input-group">
                            <button class="btn btn-break" onclick="addBreak()">Add Break (15min + 30min lunch)</button>
                            <select id="meeting-duration" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                            </select>
                            <select id="meeting-reason" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select Reason</option>
                                ${MEETING_REASONS.map(reason => `<option value="${reason}">${reason}</option>`).join('')}
                            </select>
                            <button class="btn btn-meeting" onclick="addMeeting()">Add Meeting</button>
                        </div>
                        <div id="sync-status" class="${firebaseInitialized ? 'status-online' : 'status-offline'}" style="margin-top: 10px;">
                            ${firebaseInitialized ? 'üî• Live Sync ON' : '‚ö†Ô∏è Offline Mode'}
                        </div>
                    </div>
                    
                    <!-- Current Time -->
                    <div class="card">
                        <div id="current-time" style="text-align: center; font-size: 24px; font-weight: bold; color: #007bff;"></div>
                    </div>
                    
                    <!-- Live Schedule Grid -->
                    <div id="schedule-grid" class="schedule-grid"></div>
                    
                    <!-- Live Status Board -->
                    <div class="card" style="background: #232F3E; color: white;">
                        <h2 style="color: #FF9900; text-align: center; margin-bottom: 20px;">FOC LIVE STATUS</h2>
                        <div id="live-status-content" style="font-size: 16px; line-height: 1.6;"></div>
                    </div>
                </div>`;
            
            startTimeClock();
            updateDashboard();
        }
        
        function addBreak() {
            const alias = document.getElementById('user-alias').value.trim();
            const timeSlot = document.getElementById('time-slot').value;
            
            if (!alias || !timeSlot) {
                alert('Please enter your alias and select a time slot');
                return;
            }
            
            const breakData = {
                type: 'break',
                alias: alias,
                timeSlot: timeSlot,
                duration: '15min + 30min lunch',
                timestamp: Date.now()
            };
            
            syncUserInput(breakData);
            
            // Clear inputs
            document.getElementById('user-alias').value = '';
            document.getElementById('time-slot').value = '';
            
            alert('Break added successfully!');
        }
        
        function addMeeting() {
            const alias = document.getElementById('user-alias').value.trim();
            const timeSlot = document.getElementById('time-slot').value;
            const duration = document.getElementById('meeting-duration').value;
            const reason = document.getElementById('meeting-reason').value;
            
            if (!alias || !timeSlot || !duration || !reason) {
                alert('Please fill all meeting fields');
                return;
            }
            
            const meetingData = {
                type: 'meeting',
                alias: alias,
                timeSlot: timeSlot,
                duration: duration + ' minutes',
                reason: reason,
                timestamp: Date.now()
            };
            
            syncUserInput(meetingData);
            
            // Clear inputs
            document.getElementById('user-alias').value = '';
            document.getElementById('time-slot').value = '';
            document.getElementById('meeting-duration').value = '15';
            document.getElementById('meeting-reason').value = '';
            
            alert('Meeting added successfully!');
        }
        
        function updateDashboard() {
            updateScheduleGrid();
            updateLiveStatus();
        }
        
        function updateScheduleGrid() {
            const grid = document.getElementById('schedule-grid');
            if (!grid) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            let currentTimeSlot = '';
            
            if (currentHour >= 7 && currentHour < 15) {
                currentTimeSlot = `${currentHour}:00`;
            }
            
            let gridHTML = '';
            
            TIME_SLOTS.forEach(slot => {
                const isCurrentTime = slot.time === currentTimeSlot;
                const data = scheduleData[slot.time] || { skg: [], textables: [], breaks: [], outOfOps: [] };
                
                // Get user inputs for this time slot
                const userBreaks = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === slot.time && input.type === 'break'
                );
                const userMeetings = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === slot.time && input.type === 'meeting'
                );
                
                gridHTML += `
                    <div class="time-slot ${isCurrentTime ? 'current-time' : ''}">
                        <h4 style="margin: 0 0 10px 0; color: ${isCurrentTime ? '#856404' : '#333'};">
                            ${slot.label} ${isCurrentTime ? '(CURRENT)' : ''}
                        </h4>
                        
                        <div class="team-section">
                            <strong style="color: #4CAF50;">üîç SKG Team:</strong>
                            <div class="engineer-list">
                                ${data.skg.filter(eng => eng).map(eng => `<span class="engineer-tag">${eng}</span>`).join('') || '<span style="color: #999;">No assignments</span>'}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <strong style="color: #FF9800;">üìù Textables Team:</strong>
                            <div class="engineer-list">
                                ${data.textables.filter(eng => eng).map(eng => `<span class="engineer-tag">${eng}</span>`).join('') || '<span style="color: #999;">No assignments</span>'}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <strong style="color: #2196F3;">‚òï Breaks:</strong>
                            <div class="engineer-list">
                                ${data.breaks.filter(eng => eng).map(eng => `<span class="break-tag">${eng}</span>`).join('')}
                                ${userBreaks.map(brk => `<span class="break-tag">${brk.alias} (${brk.duration})</span>`).join('')}
                                ${(data.breaks.filter(eng => eng).length === 0 && userBreaks.length === 0) ? '<span style="color: #999;">No breaks</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <strong style="color: #9C27B0;">üìÖ Meetings:</strong>
                            <div class="engineer-list">
                                ${data.outOfOps.filter(item => item.engineer).map(item => `<span class="meeting-tag">${item.engineer} - ${item.reason}</span>`).join('')}
                                ${userMeetings.map(mtg => `<span class="meeting-tag">${mtg.alias} - ${mtg.reason} (${mtg.duration})</span>`).join('')}
                                ${(data.outOfOps.filter(item => item.engineer).length === 0 && userMeetings.length === 0) ? '<span style="color: #999;">No meetings</span>' : ''}
                            </div>
                        </div>
                    </div>`;
            });
            
            grid.innerHTML = gridHTML;
        }
        
        function updateLiveStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            let currentTimeSlot = '';
            
            if (currentHour >= 7 && currentHour < 15) {
                currentTimeSlot = `${currentHour}:00`;
            }
            
            const statusContent = document.getElementById('live-status-content');
            if (!statusContent) return;
            
            let statusHTML = `<div style="text-align: center; font-size: 20px; margin-bottom: 15px; color: #FF9900;">FOC LIVE: TEAM ${currentTeam}</div>`;
            
            if (currentTimeSlot && scheduleData[currentTimeSlot]) {
                const data = scheduleData[currentTimeSlot];
                const skgCount = data.skg.filter(eng => eng !== '').length;
                const textablesCount = data.textables.filter(eng => eng !== '').length;
                const outOfOpsCount = data.outOfOps.filter(item => item.engineer !== '').length;
                
                // Count user inputs for current slot
                const userBreaksCount = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === currentTimeSlot && input.type === 'break'
                ).length;
                const userMeetingsCount = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === currentTimeSlot && input.type === 'meeting'
                ).length;
                
                statusHTML += `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="color: #4CAF50; font-size: 16px; margin-bottom: 10px;">üìä CURRENT SLOT: ${currentTimeSlot}</div>
                            <div style="margin-bottom: 8px;">üîç SKG: ${skgCount} Engineers</div>
                            <div style="margin-bottom: 8px;">üìù Textables: ${textablesCount} Engineers</div>
                            <div style="margin-bottom: 8px;">‚òï Breaks: ${userBreaksCount} Engineers</div>
                            <div style="margin-bottom: 8px;">üìÖ Meetings: ${outOfOpsCount + userMeetingsCount} Engineers</div>
                        </div>
                        <div>
                            <div style="color: #2196F3; font-size: 16px; margin-bottom: 10px;">üë• ACTIVE NOW</div>
                            <div style="font-size: 14px;">
                                Total Active: ${skgCount + textablesCount} Engineers<br>
                                Out of OPS: ${outOfOpsCount + userMeetingsCount + userBreaksCount} Engineers
                            </div>
                        </div>
                    </div>`;
            } else {
                statusHTML += `<div style="text-align: center; color: #FFB74D; font-size: 16px;">Outside operational hours (7:00-15:00)</div>`;
            }
            
            statusContent.innerHTML = statusHTML;
        }
        
        function startTimeClock() {
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', {
                    hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                const timeElement = document.getElementById('current-time');
                if (timeElement) {
                    timeElement.textContent = `Current Time: ${timeString}`;
                }
                
                // Update every minute
                if (now.getSeconds() === 0) {
                    updateDashboard();
                }
            }
            
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(updateDashboard, 30000); // Refresh every 30 seconds
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
