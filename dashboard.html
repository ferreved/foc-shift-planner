<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOC Live Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --skg-color: #8e44ad;
            --textables-color: #e67e22;
            --break-color: #34c759;
            --meeting-color: #ff3b30;
            --border-color: rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --border-color: rgba(255,255,255,0.1);
        }
        body { margin: 0; padding: 0; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text-primary); transition: all 0.3s ease; }
        .header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; position: relative; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 0 20px; }
        [data-theme="dark"] .header { background: rgba(44,44,46,0.8); }
        .header-left { display: flex; gap: 8px; }
        .header-right { display: flex; justify-content: flex-end; }
        .regional-clocks { display: flex; gap: 20px; }
        .clock-item-header { text-align: center; }
        .clock-label-header { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .clock-time-header { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .clock-date-header { font-size: 11px; color: var(--text-secondary); }
        .current-time-main { text-align: center; font-size: 20px; font-weight: 600; color: var(--text-primary); background: rgba(0,122,255,0.1); padding: 12px; border-radius: 12px; }
        .theme-toggle { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; color: var(--text-primary); }
        .theme-toggle:hover { transform: translateY(-1px); }
        .header-title { padding: 20px 0; margin: 0; font-size: 28px; font-weight: 600; color: #007aff; flex: 1; text-align: center; }
        .nav-tabs { display: flex; justify-content: center; background: transparent; padding: 0 20px 20px; }
        .nav-tab { padding: 12px 24px; color: #86868b; text-decoration: none; border-radius: 20px; transition: all 0.3s ease; margin: 0 8px; font-weight: 500; }
        .nav-tab:hover { background: rgba(0,122,255,0.1); color: #007aff; }
        .nav-tab.active { background: #007aff; color: white; }
        .main-content { padding: 20px; }
        .time-indicator { background: rgba(255,149,0,0.1) !important; border-left: 4px solid #ff9500 !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .card { background: var(--bg-secondary); border-radius: 16px; padding: 24px; margin: 16px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .input-group { display: flex; gap: 12px; align-items: center; margin: 16px 0; flex-wrap: wrap; }
        .btn { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; }
        .btn-break { background: #34c759; color: white; }
        .btn-break:hover { background: #28a745; transform: translateY(-1px); }
        .btn-meeting { background: #007aff; color: white; }
        .btn-meeting:hover { background: #0056cc; transform: translateY(-1px); }
        .status-online { color: #34c759; font-weight: 600; }
        .input-select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; min-width: 140px; }
        .schedule-grid { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; }
        .schedule-grid::-webkit-scrollbar { height: 8px; }
        .schedule-grid::-webkit-scrollbar-track { background: var(--border-color); border-radius: 4px; }
        .schedule-grid::-webkit-scrollbar-thumb { background: #007aff; border-radius: 4px; }
        .schedule-grid::-webkit-scrollbar-thumb:hover { background: #0056cc; }
        .time-slot { background: var(--bg-secondary); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color); min-width: 280px; max-width: 320px; flex-shrink: 0; }
        .current-time { background: rgba(255,149,0,0.1); border-left: 4px solid #ff9500; }
        .team-section { margin: 16px 0; }
        .engineer-list { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; word-wrap: break-word; }
        .engineer-tag { background: rgba(0,122,255,0.1); padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--text-primary); word-break: break-word; max-width: 100%; }
        .break-tag { background: rgba(52,199,89,0.1); padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--break-color); word-break: break-word; max-width: 100%; }
        .meeting-tag { background: rgba(255,59,48,0.1); padding: 6px 12px; border-radius: 12px; font-size: 13px; font-weight: 500; color: var(--meeting-color); word-break: break-word; max-width: 100%; }
        .scoreboard { background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); color: white; border-radius: 20px; padding: 32px; text-align: center; box-shadow: 0 8px 32px rgba(0,122,255,0.3); }
        .scoreboard-title { font-size: 32px; font-weight: 700; margin-bottom: 24px; }
        .scoreboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 24px; }
        .stat-box { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 16px; backdrop-filter: blur(10px); }
        .stat-number { font-size: 36px; font-weight: 700; margin-bottom: 8px; }
        .stat-label { font-size: 14px; opacity: 0.9; font-weight: 500; }
        .team-divider { height: 1px; background: var(--border-color); margin: 16px 0; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .clocks-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .clock-item { text-align: center; }
        .analog-clock { width: 80px; height: 80px; border: 3px solid var(--text-primary); border-radius: 50%; position: relative; margin: 0 auto 10px; }
        .clock-hand { position: absolute; background: var(--text-primary); transform-origin: bottom center; }
        .hour-hand { width: 3px; height: 25px; top: 15px; left: 50%; margin-left: -1.5px; }
        .minute-hand { width: 2px; height: 35px; top: 5px; left: 50%; margin-left: -1px; }
        .clock-center { width: 6px; height: 6px; background: var(--text-primary); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .clock-label { font-size: 12px; font-weight: 600; color: var(--text-primary); }
        .clock-time { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-top: 2px; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="regional-clocks">
                <div class="clock-item-header">
                    <div class="clock-label-header">üá∫üá∏ IAD</div>
                    <div class="clock-time-header" id="time-iad-header"></div>
                    <div class="clock-date-header" id="date-iad-header"></div>
                </div>
                <div class="clock-item-header">
                    <div class="clock-label-header">üá¶üá∫ SYD</div>
                    <div class="clock-time-header" id="time-syd-header"></div>
                    <div class="clock-date-header" id="date-syd-header"></div>
                </div>
                <div class="clock-item-header">
                    <div class="clock-label-header">üáÆüá≥ BOM</div>
                    <div class="clock-time-header" id="time-bom-header"></div>
                    <div class="clock-date-header" id="date-bom-header"></div>
                </div>
            </div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <h1 class="header-title">DUB Shift Planner</h1>
            <div class="nav-tabs">
                <a href="dashboard.html" class="nav-tab active">Dashboard</a>
                <a href="index.html" class="nav-tab">Create Schedule</a>
            </div>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        </div>
    </div>
    <div id="app"></div>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIF_gb3swfMlXFa4ZY4ZsoAZSwaqmiwm4",
            authDomain: "foc-dashboard.firebaseapp.com",
            databaseURL: "https://foc-dashboard-default-rtdb.firebaseio.com",
            projectId: "foc-dashboard",
            storageBucket: "foc-dashboard.firebasestorage.app",
            messagingSenderId: "869888485796",
            appId: "1:869888485796:web:82bf668dbfdc9c17a1f931"
        };
        
        let firebaseInitialized = false;
        let database, scheduleRef, breaksRef;
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            scheduleRef = database.ref('schedule');
            breaksRef = database.ref('userInputs');
            firebaseInitialized = true;
            console.log('Firebase initialized successfully');
            
            // Test connection
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                console.log('Firebase connection status:', connected ? 'Connected' : 'Disconnected');
                updateConnectionStatus(connected);
            });
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            firebaseInitialized = false;
            // Load sample data for testing
            loadSampleData();
        }
        
        const TIME_SLOTS = [
            { time: '07:00', label: '7:00' }, { time: '08:00', label: '8:00' }, { time: '09:00', label: '9:00' },
            { time: '10:00', label: '10:00' }, { time: '11:00', label: '11:00' }, { time: '12:00', label: '12:00' },
            { time: '13:00', label: '13:00' }, { time: '14:00', label: '14:00' }
        ];
        
        const MEETING_REASONS = ['1:1 Meeting', 'Other Meetings', 'Advocacy', 'Interview', 'Shadow', 'Project', 'Training'];
        const ALL_ENGINEERS = ['azjimene', 'ddunwood', 'xnevpaul', 'ssanthag', 'mwanyali', 'andrwmn', 'mcdlvega', 'criiliof', 'almelvio', 'rowhitei', 'tansthef', 'tracykie', 'shlakshy', 'kellyerd', 'ferreved'];
        
        // Individual colors for each engineer
        const ENGINEER_COLORS = {
            'azjimene': '#FF6B6B', 'ddunwood': '#4ECDC4', 'xnevpaul': '#45B7D1', 'ssanthag': '#96CEB4',
            'mwanyali': '#FFEAA7', 'andrwmn': '#DDA0DD', 'mcdlvega': '#98D8C8', 'criiliof': '#F7DC6F',
            'almelvio': '#BB8FCE', 'rowhitei': '#85C1E9', 'tansthef': '#F8C471', 'tracykie': '#82E0AA',
            'shlakshy': '#F1948A', 'kellyerd': '#85C1E9', 'ferreved': '#D7BDE2'
        };
        
        function getEngineerColor(engineer) {
            return ENGINEER_COLORS[engineer] || '#007aff';
        }
        
        function getScheduledEngineers() {
            const scheduledEngineers = new Set();
            
            // Get all engineers from all time slots in the schedule
            TIME_SLOTS.forEach(slot => {
                const data = scheduleData[slot.time];
                if (data) {
                    // Add SKG engineers
                    if (data.skg) {
                        data.skg.forEach(eng => {
                            if (eng && eng.trim() !== '') {
                                scheduledEngineers.add(eng);
                            }
                        });
                    }
                    // Add Textables engineers
                    if (data.textables) {
                        data.textables.forEach(eng => {
                            if (eng && eng.trim() !== '') {
                                scheduledEngineers.add(eng);
                            }
                        });
                    }
                }
            });
            
            return Array.from(scheduledEngineers);
        }
        
        let scheduleData = {};
        let userInputs = {};
        let currentTeam = 'A';
        let shiftLead = '';
        let stepUpLead = '';
        
        function syncUserInput(data) {
            if (!firebaseInitialized) return;
            breaksRef.push(data).catch(err => console.log('Sync failed:', err));
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function getCurrentActiveOutOfOps() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            return Object.values(userInputs || {}).filter(input => {
                if (input.type !== 'break' && input.type !== 'meeting') return false;
                
                const startMinutes = timeToMinutes(input.timeSlot);
                const durationMinutes = parseInt(input.duration.replace(' minutes', ''));
                const endMinutes = startMinutes + durationMinutes;
                
                return currentMinutes >= startMinutes && currentMinutes < endMinutes;
            });
        }
        
        function getRemainingTime(input) {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            const startMinutes = timeToMinutes(input.timeSlot);
            const durationMinutes = parseInt(input.duration.replace(' minutes', ''));
            const endMinutes = startMinutes + durationMinutes;
            
            const remainingMinutes = endMinutes - currentMinutes;
            if (remainingMinutes <= 0) return '0m';
            
            const hours = Math.floor(remainingMinutes / 60);
            const mins = remainingMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${mins}m`;
            }
            return `${mins}m`;
        }
        
        function getEndTime(input) {
            const startMinutes = timeToMinutes(input.timeSlot);
            const durationMinutes = parseInt(input.duration.replace(' minutes', ''));
            const endMinutes = startMinutes + durationMinutes;
            
            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;
            
            return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }
        
        function checkTimeOverlap(engineer, startTime, durationMinutes) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = startMinutes + durationMinutes;
            
            // Check all existing breaks and meetings for this engineer
            const existingEntries = Object.values(userInputs || {}).filter(input => 
                input.alias === engineer && (input.type === 'break' || input.type === 'meeting')
            );
            
            for (const entry of existingEntries) {
                const entryStartMinutes = timeToMinutes(entry.timeSlot);
                const entryDurationMinutes = parseInt(entry.duration.replace(' minutes', ''));
                const entryEndMinutes = entryStartMinutes + entryDurationMinutes;
                
                // Check for any overlap (even 1 minute overlap is not allowed)
                if ((startMinutes < entryEndMinutes) && (endMinutes > entryStartMinutes)) {
                    return {
                        hasOverlap: true,
                        conflictingEntry: entry
                    };
                }
            }
            return { hasOverlap: false };
        }
        
        function setupRealtimeSync() {
            if (!firebaseInitialized) {
                console.error('Firebase not initialized - running in offline mode');
                return;
            }
            
            console.log('Setting up Firebase listeners...');
            
            // Listen to schedule changes from admin
            scheduleRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Dashboard received schedule data:', data);
                if (data) {
                    scheduleData = data.scheduleData || {};
                    currentTeam = data.currentTeam || 'A';
                    shiftLead = data.shiftLead || '';
                    stepUpLead = data.stepUpLead || '';
                    console.log('Updated dashboard with:', { currentTeam, shiftLead, stepUpLead, scheduleData });
                    updateDashboard();
                } else {
                    console.warn('No schedule data received from Firebase');
                }
            }, (error) => {
                console.error('Firebase schedule listener error:', error);
            });
            
            // Listen to user inputs (breaks/meetings)
            breaksRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Dashboard received user inputs:', data);
                if (data) {
                    userInputs = data;
                    updateDashboard();
                } else {
                    console.log('No user inputs data');
                    userInputs = {};
                }
            }, (error) => {
                console.error('Firebase user inputs listener error:', error);
            });
        }
        
        function updateConnectionStatus(connected) {
            const syncStatus = document.getElementById('sync-status');
            if (syncStatus) {
                if (connected && firebaseInitialized) {
                    syncStatus.innerHTML = 'üü¢ Live Sync ON';
                    syncStatus.className = 'status-online';
                    syncStatus.style.background = 'rgba(52,199,89,0.1)';
                } else {
                    syncStatus.innerHTML = '‚ö†Ô∏è Connection Lost';
                    syncStatus.className = 'status-offline';
                    syncStatus.style.background = 'rgba(255,59,48,0.1)';
                }
            }
        }
        
        function loadSampleData() {
            console.log('Loading sample data for testing...');
            // Sample data for testing when Firebase is not available
            scheduleData = {
                '09:00': {
                    skg: ['ferreved', 'ddunwood'],
                    textables: ['azjimene', 'xnevpaul'],
                    breaks: [],
                    outOfOps: []
                },
                '10:00': {
                    skg: ['mwanyali', 'andrwmn'],
                    textables: ['mcdlvega', 'criiliof'],
                    breaks: [],
                    outOfOps: []
                }
            };
            currentTeam = 'A';
            shiftLead = 'ferreved';
            stepUpLead = 'ddunwood';
            userInputs = {};
            updateDashboard();
        }
        
        function initDashboard() {
            setupRealtimeSync();
            document.getElementById('app').innerHTML = `
                <div class="main-content" style="margin: 20px;">
                    
                    <!-- Live Status Board -->
                    <div class="scoreboard">
                        <div class="scoreboard-title">SHIFT LIVE STATUS</div>
                        <div id="live-status-content"></div>

                    </div>
                    
                    <!-- Current Time -->
                    <div id="current-time-main" class="current-time-main" style="margin-top: 10px;"></div>
                    
                    <div style="height: 10px;"></div>
                    

                    
                    <!-- Live Schedule Grid -->
                    <div id="schedule-grid" class="schedule-grid"></div>
                    
                    <!-- User Input Section -->
                    <div class="card">
                        <h3 class="section-title" style="margin-top: 0; color: #34c759;">‚òï Add Break</h3>
                        <div class="input-group">
                            <select id="break-engineer" class="input-select" onchange="updateBreakTimeSlots()">
                                <option value="">Select Engineer</option>
                            </select>
                            <select id="break-time-slot" class="input-select">
                                <option value="">Select Start Time</option>
                                <option value="07:00">07:00</option><option value="07:15">07:15</option><option value="07:30">07:30</option><option value="07:45">07:45</option>
                                <option value="08:00">08:00</option><option value="08:15">08:15</option><option value="08:30">08:30</option><option value="08:45">08:45</option>
                                <option value="09:00">09:00</option><option value="09:15">09:15</option><option value="09:30">09:30</option><option value="09:45">09:45</option>
                                <option value="10:00">10:00</option><option value="10:15">10:15</option><option value="10:30">10:30</option><option value="10:45">10:45</option>
                                <option value="11:00">11:00</option><option value="11:15">11:15</option><option value="11:30">11:30</option><option value="11:45">11:45</option>
                                <option value="12:00">12:00</option><option value="12:15">12:15</option><option value="12:30">12:30</option><option value="12:45">12:45</option>
                                <option value="13:00">13:00</option><option value="13:15">13:15</option><option value="13:30">13:30</option><option value="13:45">13:45</option>
                                <option value="14:00">14:00</option><option value="14:15">14:15</option><option value="14:30">14:30</option><option value="14:45">14:45</option>
                            </select>
                            <select id="break-duration" class="input-select">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                            <button class="btn btn-break" onclick="addBreak()">Add Break</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="section-title" style="margin-top: 0; color: #007aff;">üìÖ Add Meeting</h3>
                        <div class="input-group">
                            <select id="meeting-engineer" class="input-select">
                                <option value="">Select Engineer</option>
                            </select>
                            <select id="meeting-time-slot" class="input-select">
                                <option value="">Select Start Time</option>
                                <option value="07:00">07:00</option><option value="07:15">07:15</option><option value="07:30">07:30</option><option value="07:45">07:45</option>
                                <option value="08:00">08:00</option><option value="08:15">08:15</option><option value="08:30">08:30</option><option value="08:45">08:45</option>
                                <option value="09:00">09:00</option><option value="09:15">09:15</option><option value="09:30">09:30</option><option value="09:45">09:45</option>
                                <option value="10:00">10:00</option><option value="10:15">10:15</option><option value="10:30">10:30</option><option value="10:45">10:45</option>
                                <option value="11:00">11:00</option><option value="11:15">11:15</option><option value="11:30">11:30</option><option value="11:45">11:45</option>
                                <option value="12:00">12:00</option><option value="12:15">12:15</option><option value="12:30">12:30</option><option value="12:45">12:45</option>
                                <option value="13:00">13:00</option><option value="13:15">13:15</option><option value="13:30">13:30</option><option value="13:45">13:45</option>
                                <option value="14:00">14:00</option><option value="14:15">14:15</option><option value="14:30">14:30</option><option value="14:45">14:45</option>
                            </select>
                            <select id="meeting-duration" class="input-select">
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60">1 hour</option>
                            </select>
                            <select id="meeting-reason" class="input-select">
                                <option value="">Select Reason</option>
                                ${MEETING_REASONS.map(reason => `<option value="${reason}">${reason}</option>`).join('')}
                            </select>
                            <button class="btn btn-meeting" onclick="addMeeting()">Add Meeting</button>
                        </div>
                        <div id="sync-status" class="${firebaseInitialized ? 'status-online' : 'status-offline'}" style="margin-top: 16px; padding: 12px; border-radius: 10px; background: ${firebaseInitialized ? 'rgba(52,199,89,0.1)' : 'rgba(255,59,48,0.1)'}; font-size: 14px; font-weight: 500;">
                            ${firebaseInitialized ? 'üü¢ Live Sync ON' : '‚ö†Ô∏è Offline Mode'}
                        </div>
                    </div>
                </div>`;
            
            startTimeClock();
            updateDashboard();
        }
        
        function isEngineerOnSKG(engineer, timeSlot) {
            if (!scheduleData[timeSlot] || !scheduleData[timeSlot].skg) return false;
            return scheduleData[timeSlot].skg.includes(engineer);
        }
        
        function updateBreakTimeSlots() {
            const engineerSelect = document.getElementById('break-engineer');
            const timeSlotSelect = document.getElementById('break-time-slot');
            
            if (!engineerSelect || !timeSlotSelect) return;
            
            const selectedEngineer = engineerSelect.value;
            
            // Clear existing options except the first one
            timeSlotSelect.innerHTML = '<option value="">Select Start Time</option>';
            
            if (!selectedEngineer) {
                // If no engineer selected, show all time slots
                const allTimeSlots = [
                    '07:00', '07:15', '07:30', '07:45',
                    '08:00', '08:15', '08:30', '08:45',
                    '09:00', '09:15', '09:30', '09:45',
                    '10:00', '10:15', '10:30', '10:45',
                    '11:00', '11:15', '11:30', '11:45',
                    '12:00', '12:15', '12:30', '12:45',
                    '13:00', '13:15', '13:30', '13:45',
                    '14:00', '14:15', '14:30', '14:45'
                ];
                allTimeSlots.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSlotSelect.appendChild(option);
                });
                return;
            }
            
            // Filter time slots - only show times when engineer is NOT on SKG
            const availableTimeSlots = [
                '07:00', '07:15', '07:30', '07:45',
                '08:00', '08:15', '08:30', '08:45',
                '09:00', '09:15', '09:30', '09:45',
                '10:00', '10:15', '10:30', '10:45',
                '11:00', '11:15', '11:30', '11:45',
                '12:00', '12:15', '12:30', '12:45',
                '13:00', '13:15', '13:30', '13:45',
                '14:00', '14:15', '14:30', '14:45'
            ].filter(time => {
                // Convert 15-minute slots to hourly slots for SKG check
                const hourSlot = time.split(':')[0] + ':00';
                return !isEngineerOnSKG(selectedEngineer, hourSlot);
            });
            
            availableTimeSlots.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSlotSelect.appendChild(option);
            });
            
            if (availableTimeSlots.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No available slots (engineer on SKG all day)';
                option.disabled = true;
                timeSlotSelect.appendChild(option);
            }
        }
        
        function addBreak() {
            const alias = document.getElementById('break-engineer').value;
            const timeSlot = document.getElementById('break-time-slot').value;
            const duration = document.getElementById('break-duration').value;
            
            if (!alias || !timeSlot || !duration) {
                alert('Please select engineer, time slot, and duration');
                return;
            }
            
            // Check for time overlap
            const durationMinutes = parseInt(duration);
            const overlapCheck = checkTimeOverlap(alias, timeSlot, durationMinutes);
            if (overlapCheck.hasOverlap) {
                const conflict = overlapCheck.conflictingEntry;
                alert(`Cannot schedule break: Time overlaps with existing ${conflict.type} for ${alias} at ${conflict.timeSlot} (${conflict.duration}).`);
                return;
            }
            
            // Double-check that engineer is not on SKG for this time slot
            const hourSlot = timeSlot.split(':')[0] + ':00';
            if (isEngineerOnSKG(alias, hourSlot)) {
                alert('Cannot schedule break: Engineer is assigned to SKG during this time slot.');
                return;
            }
            
            const breakData = {
                type: 'break',
                alias: alias,
                timeSlot: timeSlot,
                duration: duration + ' minutes',
                timestamp: Date.now()
            };
            
            syncUserInput(breakData);
            
            // Clear inputs
            document.getElementById('break-engineer').value = '';
            document.getElementById('break-time-slot').value = '';
            document.getElementById('break-duration').value = '15';
            updateBreakTimeSlots(); // Reset time slots
            
            alert('Break added successfully!');
        }
        
        function addMeeting() {
            const alias = document.getElementById('meeting-engineer').value;
            const timeSlot = document.getElementById('meeting-time-slot').value;
            const duration = document.getElementById('meeting-duration').value;
            const reason = document.getElementById('meeting-reason').value;
            
            if (!alias || !timeSlot || !duration || !reason) {
                alert('Please fill all meeting fields');
                return;
            }
            
            // Check for time overlap
            const durationMinutes = parseInt(duration);
            const overlapCheck = checkTimeOverlap(alias, timeSlot, durationMinutes);
            if (overlapCheck.hasOverlap) {
                const conflict = overlapCheck.conflictingEntry;
                alert(`Cannot schedule meeting: Time overlaps with existing ${conflict.type} for ${alias} at ${conflict.timeSlot} (${conflict.duration}).`);
                return;
            }
            
            const meetingData = {
                type: 'meeting',
                alias: alias,
                timeSlot: timeSlot,
                duration: duration + ' minutes',
                reason: reason,
                timestamp: Date.now()
            };
            
            syncUserInput(meetingData);
            
            // Clear inputs
            document.getElementById('meeting-engineer').value = '';
            document.getElementById('meeting-time-slot').value = '';
            document.getElementById('meeting-duration').value = '15';
            document.getElementById('meeting-reason').value = '';
            
            alert('Meeting added successfully!');
        }
        
        function scrollToCurrentTimeSlot() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:00`;
            
            const currentCard = document.querySelector(`[data-time="${currentTimeSlot}"]`);
            const grid = document.getElementById('schedule-grid');
            
            if (currentCard && grid) {
                const cardLeft = currentCard.offsetLeft;
                const cardWidth = currentCard.offsetWidth;
                const gridWidth = grid.offsetWidth;
                
                // Center the current card in view
                const scrollPosition = cardLeft - (gridWidth / 2) + (cardWidth / 2);
                
                grid.scrollTo({
                    left: Math.max(0, scrollPosition),
                    behavior: 'smooth'
                });
            }
        }
        
        function manualRefresh() {
            console.log('Manual refresh triggered');
            if (firebaseInitialized) {
                // Force refresh from Firebase
                scheduleRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    console.log('Manual refresh - schedule data:', data);
                    if (data) {
                        scheduleData = data.scheduleData || {};
                        currentTeam = data.currentTeam || 'A';
                        shiftLead = data.shiftLead || '';
                        stepUpLead = data.stepUpLead || '';
                        updateDashboard();
                    }
                }).catch(error => {
                    console.error('Manual refresh failed:', error);
                });
                
                breaksRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    console.log('Manual refresh - user inputs:', data);
                    userInputs = data || {};
                    updateDashboard();
                }).catch(error => {
                    console.error('Manual refresh user inputs failed:', error);
                });
            } else {
                loadSampleData();
            }
        }
        
        function updateDashboard() {
            console.log('Updating dashboard with data:', { scheduleData, currentTeam, shiftLead, stepUpLead });
            updateScheduleGrid();
            updateLiveStatus();
            updateEngineerDropdowns(); // Update engineer dropdowns based on schedule
            updateBreakTimeSlots(); // Update available break time slots when schedule changes
        }
        
        function updateEngineerDropdowns() {
            const scheduledEngineers = getScheduledEngineers();
            
            // Update break engineer dropdown
            const breakSelect = document.getElementById('break-engineer');
            if (breakSelect) {
                const currentValue = breakSelect.value;
                breakSelect.innerHTML = '<option value="">Select Engineer</option>';
                scheduledEngineers.forEach(engineer => {
                    const option = document.createElement('option');
                    option.value = engineer;
                    option.textContent = engineer;
                    if (engineer === currentValue) option.selected = true;
                    breakSelect.appendChild(option);
                });
            }
            
            // Update meeting engineer dropdown
            const meetingSelect = document.getElementById('meeting-engineer');
            if (meetingSelect) {
                const currentValue = meetingSelect.value;
                meetingSelect.innerHTML = '<option value="">Select Engineer</option>';
                scheduledEngineers.forEach(engineer => {
                    const option = document.createElement('option');
                    option.value = engineer;
                    option.textContent = engineer;
                    if (engineer === currentValue) option.selected = true;
                    meetingSelect.appendChild(option);
                });
            }
        }
        
        function updateScheduleGrid() {
            const grid = document.getElementById('schedule-grid');
            if (!grid) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:00`;
            
            let gridHTML = '';
            
            TIME_SLOTS.forEach(slot => {
                const isCurrentTime = slot.time === currentTimeSlot;
                const data = scheduleData[slot.time] || { skg: [], textables: [], breaks: [], outOfOps: [] };
                
                // Ensure arrays exist
                if (!data.skg) data.skg = [];
                if (!data.textables) data.textables = [];
                if (!data.breaks) data.breaks = [];
                if (!data.outOfOps) data.outOfOps = [];
                
                // Get user inputs that are active during this time slot (including those that span multiple slots)
                function isActiveInTimeSlot(input, slotTime) {
                    const inputStartMinutes = timeToMinutes(input.timeSlot);
                    const inputDurationMinutes = parseInt(input.duration.replace(' minutes', ''));
                    const inputEndMinutes = inputStartMinutes + inputDurationMinutes;
                    
                    const slotStartMinutes = timeToMinutes(slotTime);
                    const slotEndMinutes = slotStartMinutes + 60; // Each slot is 1 hour
                    
                    // Check if input overlaps with this time slot
                    // Exclude meetings that end exactly at the start of the next slot (no overlap)
                    return (inputStartMinutes < slotEndMinutes) && (inputEndMinutes > slotStartMinutes);
                }
                
                const userBreaks = Object.values(userInputs || {}).filter(input => 
                    input.type === 'break' && isActiveInTimeSlot(input, slot.time)
                );
                const userMeetings = Object.values(userInputs || {}).filter(input => 
                    input.type === 'meeting' && isActiveInTimeSlot(input, slot.time)
                );
                
                gridHTML += `
                    <div class="time-slot ${isCurrentTime ? 'current-time' : ''}" data-time="${slot.time}">
                        <h4 style="margin: 0 0 16px 0; color: ${isCurrentTime ? '#ff9500' : 'var(--text-primary)'}; font-size: 18px; font-weight: 600;">
                            ${slot.label} ${isCurrentTime ? '(CURRENT)' : ''}
                        </h4>
                        
                        <div class="team-section">
                            <div class="section-title" style="color: var(--skg-color);">üõ∞Ô∏è SKG Team</div>
                            <div class="engineer-list">
                                ${(data.skg || []).filter(eng => eng).map(eng => {
                                    // Only show emoji in current time slot card
                                    let icon = '';
                                    if (isCurrentTime) {
                                        const activeOutOfOps = getCurrentActiveOutOfOps();
                                        const currentlyOut = activeOutOfOps.find(input => input.alias === eng);
                                        if (currentlyOut) {
                                            icon = currentlyOut.type === 'break' ? ' ‚òï' : ' üìÖ';
                                        }
                                    }
                                    const engineerColor = getEngineerColor(eng);
                                    return `<span class="engineer-tag" style="background: ${engineerColor}20; border: 1px solid ${engineerColor}; color: var(--text-primary);">${eng}${icon}</span>`;
                                }).join('') || '<span style="color: var(--text-secondary); font-style: italic;">No assignments</span>'}
                            </div>
                        </div>
                        
                        <div class="team-divider"></div>
                        
                        <div class="team-section">
                            <div class="section-title" style="color: var(--textables-color);">üìã Textables Team</div>
                            <div class="engineer-list">
                                ${(data.textables || []).filter(eng => eng).map(eng => {
                                    // Only show emoji in current time slot card
                                    let icon = '';
                                    if (isCurrentTime) {
                                        const activeOutOfOps = getCurrentActiveOutOfOps();
                                        const currentlyOut = activeOutOfOps.find(input => input.alias === eng);
                                        if (currentlyOut) {
                                            icon = currentlyOut.type === 'break' ? ' ‚òï' : ' üìÖ';
                                        }
                                    }
                                    const engineerColor = getEngineerColor(eng);
                                    return `<span class="engineer-tag" style="background: ${engineerColor}20; border: 1px solid ${engineerColor}; color: var(--text-primary);">${eng}${icon}</span>`;
                                }).join('') || '<span style="color: var(--text-secondary); font-style: italic;">No assignments</span>'}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <div class="section-title" style="color: #34c759;">‚òï Breaks</div>
                            <div class="engineer-list">
                                ${(data.breaks || []).filter(eng => eng).map(eng => `<span class="break-tag" style="color: var(--text-primary);">‚òï ${eng}</span>`).join('')}
                                ${userBreaks.map(brk => {
                                    const endTime = getEndTime(brk);
                                    return `<span class="break-tag" style="color: var(--text-primary);">‚òï ${brk.alias} ${brk.timeSlot} - ${endTime}<br><span style="font-size: 10px; opacity: 0.8;">Break (${brk.duration})</span></span>`;
                                }).join('')}
                                ${((data.breaks || []).filter(eng => eng).length === 0 && userBreaks.length === 0) ? '<span style="color: var(--text-secondary); font-style: italic;">No breaks</span>' : ''}
                            </div>
                        </div>
                        
                        <div class="team-section">
                            <div class="section-title" style="color: #ff3b30;">üìÖ Meetings</div>
                            <div class="engineer-list">
                                ${(data.outOfOps || []).filter(item => item && item.engineer).map(item => `<span class="meeting-tag" style="color: var(--text-primary);">üìÖ ${item.engineer} - ${item.reason}</span>`).join('')}
                                ${userMeetings.map(mtg => {
                                    const endTime = getEndTime(mtg);
                                    return `<span class="meeting-tag" style="color: var(--text-primary);">üìÖ ${mtg.alias} ${mtg.timeSlot} - ${endTime}<br><span style="font-size: 10px; opacity: 0.8;">${mtg.reason} (${mtg.duration})</span></span>`;
                                }).join('')}
                                ${((data.outOfOps || []).filter(item => item && item.engineer).length === 0 && userMeetings.length === 0) ? '<span style="color: var(--text-secondary); font-style: italic;">No meetings</span>' : ''}
                            </div>
                        </div>
                    </div>`;
            });
            
            grid.innerHTML = gridHTML;
            
            // Auto-scroll to current time slot
            scrollToCurrentTimeSlot();
        }
        
        function updateLiveStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:00`;
            
            const statusContent = document.getElementById('live-status-content');
            if (!statusContent) return;
            
            let statusHTML = `<div style="font-size: 24px; margin-bottom: 20px; font-weight: 700;">TEAM ${currentTeam} - ${currentTimeSlot}</div>`;
            statusHTML += `<div style="font-size: 16px; margin-bottom: 20px; opacity: 0.9;">Shift Lead: ${shiftLead || 'Not Set'} | Step-up Lead: ${stepUpLead || 'Not Set'}</div>`;
            
            const data = scheduleData[currentTimeSlot];
            if (data) {
                // Get engineers currently out of ops
                const activeOutOfOps = getCurrentActiveOutOfOps();
                const outOfOpsEngineers = activeOutOfOps.map(input => input.alias);
                
                // Filter out engineers who are currently out of ops
                const activeSkgEngineers = (data.skg || []).filter(eng => eng !== '' && !outOfOpsEngineers.includes(eng));
                const activeTextablesEngineers = (data.textables || []).filter(eng => eng !== '' && !outOfOpsEngineers.includes(eng));
                
                const skgCount = activeSkgEngineers.length;
                const textablesCount = activeTextablesEngineers.length;
                
                const skgTags = activeSkgEngineers.map(eng => {
                    const engineerColor = getEngineerColor(eng);
                    return `<span style="background: ${engineerColor}; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px; margin: 2px; display: inline-block; font-weight: 500;">${eng}</span>`;
                }).join('');
                
                const textablesTags = activeTextablesEngineers.map(eng => {
                    const engineerColor = getEngineerColor(eng);
                    return `<span style="background: ${engineerColor}; color: white; padding: 4px 8px; border-radius: 8px; font-size: 11px; margin: 2px; display: inline-block; font-weight: 500;">${eng}</span>`;
                }).join('');
                
                statusHTML += `
                    <div class="scoreboard-stats" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="stat-box">
                            <div class="stat-number">${skgCount}</div>
                            <div class="stat-label">SKG ENGINEERS</div>
                            <div style="font-size: 12px; margin-top: 8px; line-height: 1.4;">${skgTags || '<span style="opacity: 0.8;">None</span>'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${textablesCount}</div>
                            <div class="stat-label">TEXTABLES ENGINEERS</div>
                            <div style="font-size: 12px; margin-top: 8px; line-height: 1.4;">${textablesTags || '<span style="opacity: 0.8;">None</span>'}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="out-of-ops-count">0</div>
                            <div class="stat-label">OUT OF OPS</div>
                            <div style="font-size: 11px; margin-top: 8px; line-height: 1.4;" id="out-of-ops-list">None</div>
                        </div>
                    </div>`;
            } else {
                statusHTML += `<div style="font-size: 18px; opacity: 0.8;">No schedule data for ${currentTimeSlot}</div>`;
            }
            
            statusContent.innerHTML = statusHTML;
            
            // Update out-of-ops with live data
            updateOutOfOpsLive();
        }
        
        function updateOutOfOpsLive() {
            const activeOutOfOps = getCurrentActiveOutOfOps();
            const countElement = document.getElementById('out-of-ops-count');
            const listElement = document.getElementById('out-of-ops-list');
            
            if (countElement && listElement) {
                countElement.textContent = activeOutOfOps.length;
                
                if (activeOutOfOps.length === 0) {
                    listElement.innerHTML = '<span style="opacity: 0.8;">None</span>';
                } else {
                    const outOfOpsTags = activeOutOfOps.map(input => {
                        const icon = input.type === 'break' ? '‚òï' : 'üìÖ';
                        const endTime = getEndTime(input);
                        const remaining = getRemainingTime(input);
                        const reason = input.type === 'break' ? 'Break' : input.reason;
                        
                        return `<div style="margin: 2px 0; padding: 3px; background: rgba(255,255,255,0.1); border-radius: 4px;">
                            ${icon} ${input.alias} ${input.timeSlot} - ${endTime}<br>
                            <span style="opacity: 0.8; font-size: 10px;">${reason} - Remaining: ${remaining}</span>
                        </div>`;
                    }).join('');
                    
                    listElement.innerHTML = outOfOpsTags;
                }
            }
        }
        
        function updateAnalogClock(region, hours, minutes) {
            const hourHand = document.getElementById(`hour-hand-${region}`);
            const minuteHand = document.getElementById(`minute-hand-${region}`);
            
            if (hourHand && minuteHand) {
                const hourAngle = (hours % 12) * 30 + minutes * 0.5;
                const minuteAngle = minutes * 6;
                
                hourHand.style.transform = `rotate(${hourAngle}deg)`;
                minuteHand.style.transform = `rotate(${minuteAngle}deg)`;
            }
        }
        
        function startTimeClock() {
            function updateTime() {
                const now = new Date();
                
                // Update date and time together
                const dateString = now.toLocaleDateString('en-GB', {
                    weekday: 'short',
                    day: '2-digit',
                    month: 'short'
                }).toUpperCase();
                
                const timeString = now.toLocaleTimeString('en-GB', {
                    hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                const timeElement = document.getElementById('current-time-main');
                if (timeElement) {
                    timeElement.textContent = ` ${dateString} - ${timeString}`;
                }
                
                // Update regional times
                const iadTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                const sydTime = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Sydney"}));
                const bomTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
                
                // Update digital times in header
                const iadElement = document.getElementById('time-iad-header');
                const sydElement = document.getElementById('time-syd-header');
                const bomElement = document.getElementById('time-bom-header');
                const iadDateElement = document.getElementById('date-iad-header');
                const sydDateElement = document.getElementById('date-syd-header');
                const bomDateElement = document.getElementById('date-bom-header');
                
                if (iadElement) {
                    iadElement.textContent = iadTime.toLocaleTimeString('en-GB', {
                        hour12: false, hour: '2-digit', minute: '2-digit'
                    });
                }
                if (sydElement) {
                    sydElement.textContent = sydTime.toLocaleTimeString('en-GB', {
                        hour12: false, hour: '2-digit', minute: '2-digit'
                    });
                }
                if (bomElement) {
                    bomElement.textContent = bomTime.toLocaleTimeString('en-GB', {
                        hour12: false, hour: '2-digit', minute: '2-digit'
                    });
                }
                
                // Update regional dates
                if (iadDateElement) {
                    iadDateElement.textContent = iadTime.toLocaleDateString('en-GB', {
                        weekday: 'short', day: '2-digit', month: 'short'
                    }).toUpperCase();
                }
                if (sydDateElement) {
                    sydDateElement.textContent = sydTime.toLocaleDateString('en-GB', {
                        weekday: 'short', day: '2-digit', month: 'short'
                    }).toUpperCase();
                }
                if (bomDateElement) {
                    bomDateElement.textContent = bomTime.toLocaleDateString('en-GB', {
                        weekday: 'short', day: '2-digit', month: 'short'
                    }).toUpperCase();
                }
                
                // Update every minute
                if (now.getSeconds() === 0) {
                    updateDashboard();
                }
            }
            
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(updateDashboard, 30000); // Refresh every 30 seconds
            setInterval(updateOutOfOpsLive, 1000); // Update out-of-ops every second for live countdown
        }
        
        // Theme toggle functionality
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDarkMode);
        }
        
        function initTheme() {
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initDashboard();
        });
    </script>
</body>
</html>
