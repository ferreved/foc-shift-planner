<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOC Admin - Create Schedule</title>
    <style>
        body { margin: 0; padding: 0; background: #f5f5f5; font-family: Arial, sans-serif; }
        .header { background: #232F3E; color: white; padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-title { text-align: center; padding: 15px 0; margin: 0; font-size: 24px; color: #FF9900; }
        .nav-tabs { display: flex; justify-content: center; background: #37475A; }
        .nav-tab { padding: 12px 24px; color: white; text-decoration: none; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-tab:hover { background: #4A5F7A; }
        .nav-tab.active { background: #FF9900; color: #232F3E; border-bottom-color: #FF9900; }
        .main-content { padding: 20px; }
        .time-indicator { background: #ffebee !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .engineer-select { width: 80px; padding: 2px; border: 1px solid #ccc; border-radius: 3px; font-size: 10px; }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <h1 class="header-title">DUB Shift Planner</h1>
        <div class="nav-tabs">
            <a href="dashboard.html" class="nav-tab">Dashboard</a>
            <a href="index.html" class="nav-tab active">Create Schedule</a>
        </div>
    </div>
    <div id="app"></div>
    <script>
        const TEAMS = {
            A: ['azjimene', 'ddunwood', 'xnevpaul', 'ssanthag', 'mwanyali', 'andrwmn', 'mcdlvega'],
            B: ['criiliof', 'almelvio', 'rowhitei', 'tansthef', 'tracykie', 'shlakshy', 'kellyerd', 'ferreved']
        };
        const TIME_SLOTS = [
            { time: '07:00', label: '7:00' }, { time: '08:00', label: '8:00' }, { time: '09:00', label: '9:00' },
            { time: '10:00', label: '10:00' }, { time: '11:00', label: '11:00' }, { time: '12:00', label: '12:00' },
            { time: '13:00', label: '13:00' }, { time: '14:00', label: '14:00' }
        ];
        
        let currentTeam = 'A', availableEngineers = [...TEAMS.A], extraEngineers = [], engineersOff = [], scheduleData = {}, shiftLead = '', stepUpLead = '', userInputs = {};
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIF_gb3swfMlXFa4ZY4ZsoAZSwaqmiwm4",
            authDomain: "foc-dashboard.firebaseapp.com",
            databaseURL: "https://foc-dashboard-default-rtdb.firebaseio.com",
            projectId: "foc-dashboard",
            storageBucket: "foc-dashboard.firebasestorage.app",
            messagingSenderId: "869888485796",
            appId: "1:869888485796:web:82bf668dbfdc9c17a1f931"
        };
        
        let firebaseInitialized = false;
        let database, scheduleRef, userInputsRef;
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            scheduleRef = database.ref('schedule');
            userInputsRef = database.ref('userInputs');
            firebaseInitialized = true;
        } catch (error) {
            firebaseInitialized = false;
        }
        
        // Real-time sync functions
        function syncToFirebase() {
            if (!firebaseInitialized) return;
            const data = { currentTeam, availableEngineers, extraEngineers, engineersOff, scheduleData, shiftLead, stepUpLead, lastUpdated: Date.now() };
            scheduleRef.set(data).catch(err => console.log('Sync failed:', err));
        }
        
        function setupRealtimeSync() {
            if (!firebaseInitialized) return;
            scheduleRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.lastUpdated !== window.lastUpdate) {
                    currentTeam = data.currentTeam || 'A';
                    availableEngineers = data.availableEngineers || [...TEAMS.A];
                    extraEngineers = data.extraEngineers || [];
                    engineersOff = data.engineersOff || [];
                    scheduleData = data.scheduleData || {};
                    shiftLead = data.shiftLead || '';
                    stepUpLead = data.stepUpLead || '';
                    window.lastUpdate = data.lastUpdated;
                    updateDisplayFromSync();
                }
            });
            
            // Listen to user inputs from dashboard
            userInputsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                userInputs = data || {};
                updateUserInputsDisplay();
            });
        }
        
        function updateDisplayFromSync() {
            if (document.getElementById('team-selector')) document.getElementById('team-selector').value = currentTeam;
            if (document.getElementById('shift-lead-display')) document.getElementById('shift-lead-display').textContent = shiftLead;
            if (document.getElementById('stepup-lead-display')) document.getElementById('stepup-lead-display').textContent = stepUpLead;
            updateExtraEngineersDisplay();
            updateEngineersOffDisplay();
            updateScheduleTable();
        }
        
        let isAuthenticated = false;
        
        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: calc(100vh - 120px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-width: 400px; width: 100%;">
                        <h2 style="text-align: center; color: #333; margin-bottom: 30px;">üîê Admin Access</h2>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Username:</label>
                            <input type="text" id="username" placeholder="Enter username" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        </div>
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Password:</label>
                            <input type="password" id="password" placeholder="Enter password" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
                        </div>
                        <button onclick="login()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">Login</button>
                        <div style="text-align: center;">
                            <a href="dashboard.html" style="color: #007bff; text-decoration: none;">üìä View Public Dashboard</a>
                        </div>
                    </div>
                </div>`;
        }
        
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            const validUsers = {
                'admin': 'foc2024',
                'shiftlead': 'lead123',
                'manager': 'mgr456'
            };
            
            if (validUsers[username] === password) {
                isAuthenticated = true;
                initDashboard();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        }
        
        function initDashboard() {
            if (!isAuthenticated) {
                showLogin();
                return;
            }
            
            setupRealtimeSync();
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 style="color: #232F3E; margin: 0;">Create Schedule</h1>
                        <div>
                            <a href="dashboard.html" target="_blank" style="background: #28a745; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; margin-right: 10px;">üìä View Dashboard</a>
                            <button onclick="logout()" style="background: #dc3545; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">Logout</button>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                            <button id="new-schedule-btn" style="background: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">New Schedule</button>
                            <button id="new-day-btn" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">üåÖ Start New Day</button>
                            <div><label>Team: </label><select id="team-selector" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                <option value="A">Team A</option><option value="B">Team B</option><option value="AB">Team A/B</option>
                                <option value="AB_PROJECT_A">Team A/B Project for A</option><option value="AB_PROJECT_B">Team A/B Project for B</option>
                            </select></div>
                            <button id="auto-populate-btn" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Auto Populate</button>
                            <div id="sync-status" class="${firebaseInitialized ? 'status-online' : 'status-offline'}">${firebaseInitialized ? 'üî• Live Sync ON' : '‚ö†Ô∏è Offline Mode'}</div>
                            <button onclick="publishSchedule()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">üì§ Publish to Dashboard</button>
                        </div>
                        <div id="current-time" style="text-align: center; font-size: 18px; font-weight: bold; margin-top: 10px; color: #007bff;"></div>
                        <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
                            <div><label>Extra Engineers: </label><select id="extra-engineer-select" style="margin-right: 10px;"><option value="">Select Engineer for Extra Hours</option></select>
                            <button onclick="addExtraEngineer()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Add</button>
                            <div id="extra-engineers-list" style="margin-top: 5px;"></div></div>
                            <div><label>Engineers Off: </label><select id="engineer-off-select" style="margin-right: 10px;"><option value="">Select Engineer Off</option></select>
                            <button onclick="addEngineerOff()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Add</button>
                            <div id="engineers-off-list" style="margin-top: 5px;"></div></div>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 12px;">
                            <tr><td style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #e3f2fd;">Shift Lead</td>
                            <td colspan="12" style="padding: 8px; border: 1px solid #000; background: #e3f2fd;"><select id="shift-lead-selector" style="width: 200px; padding: 4px;"><option value="">Select Shift Lead</option></select><span id="shift-lead-display" style="margin-left: 10px; font-weight: bold;"></span></td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #e3f2fd;">Step-up Lead</td>
                            <td colspan="12" style="padding: 8px; border: 1px solid #000; background: #e3f2fd;"><select id="stepup-lead-selector" style="width: 200px; padding: 4px;"><option value="">Select Step-up Lead</option></select><span id="stepup-lead-display" style="margin-left: 10px; font-weight: bold;"></span></td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #fff3cd;">06:00 to 07:00</td><td colspan="12" style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #fff3cd; text-align: center;">Project Hour</td></tr>
                            <tr><td colspan="13" style="padding: 4px; border: none;"></td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #000; background: #f0f0f0;"></td>
                            <td colspan="6" style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Raiding SKG</td>
                            <td colspan="6" style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Textables and FOC slack requests</td></tr>
                            <tr><td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; font-weight: bold;">Primary</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 1</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 2</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 3</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 4</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 5</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 6</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 1</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 2</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 3</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 4</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 5</td>
                            <td style="padding: 8px; border: 1px solid #000; background: #f0f0f0; text-align: center; font-weight: bold;">Eng 6</td></tr>
                            <tbody id="schedule-tbody"></tbody>
                            <tr><td style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #fff3cd;">15:00 to 16:00</td><td colspan="12" style="padding: 8px; border: 1px solid #000; font-weight: bold; background: #fff3cd; text-align: center;">Project Hour</td></tr>
                        </table>
                    </div>
                    
                    <!-- User Inputs from Dashboard -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="color: #232F3E; margin-top: 0;">üìù Live User Inputs from Dashboard</h3>
                        <div id="user-inputs-display" style="font-size: 14px;"></div>
                    </div>
                    
                    <div style="background: #232F3E; color: white; padding: 20px; border-radius: 8px; margin-top: 20px; font-family: 'Courier New', monospace;">
                        <h2 style="color: #FF9900; text-align: center; margin-bottom: 20px; font-size: 24px;">FOC LIVE STATUS</h2>
                        <div id="live-status-content" style="font-size: 18px; line-height: 1.6;"></div>
                    </div>
                </div>`;
            attachEventListeners();
            initializeScheduleData();
            updateDashboard();
            startTimeClock();
        }
        
        function publishSchedule() {
            if (confirm('Publish current schedule to dashboard? This will make it visible to all users.')) {
                syncToFirebase();
                alert('Schedule published successfully! ‚úÖ');
            }
        }
        
        function updateUserInputsDisplay() {
            const container = document.getElementById('user-inputs-display');
            if (!container) return;
            
            const inputs = Object.values(userInputs || {});
            if (inputs.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No user inputs yet.</p>';
                return;
            }
            
            const groupedInputs = {};
            inputs.forEach(input => {
                if (!groupedInputs[input.timeSlot]) {
                    groupedInputs[input.timeSlot] = [];
                }
                groupedInputs[input.timeSlot].push(input);
            });
            
            let html = '';
            Object.keys(groupedInputs).sort().forEach(timeSlot => {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #007bff;">`;
                html += `<strong style="color: #007bff;">${timeSlot}</strong><br>`;
                groupedInputs[timeSlot].forEach(input => {
                    const icon = input.type === 'break' ? '‚òï' : 'üìÖ';
                    const color = input.type === 'break' ? '#28a745' : '#dc3545';
                    html += `<span style="color: ${color}; margin-right: 15px;">${icon} ${input.alias} - ${input.type === 'break' ? input.duration : input.reason + ' (' + input.duration + ')'}</span>`;
                });
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function attachEventListeners() {
            document.getElementById('new-schedule-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to start a new schedule? All current data will be lost.')) {
                    initializeScheduleData();
                    updateDashboard();
                    syncToFirebase();
                }
            });
            
            document.getElementById('new-day-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to start a new day? This will reset ALL data including breaks and meetings from dashboard.')) {
                    startNewDay();
                }
            });
            
            document.getElementById('team-selector').addEventListener('change', (e) => {
                currentTeam = e.target.value;
                updateAvailableEngineers();
                updateLeaderSelectors();
                updateDashboard();
                syncToFirebase();
            });
            
            document.getElementById('shift-lead-selector').addEventListener('change', (e) => {
                shiftLead = e.target.value;
                document.getElementById('shift-lead-display').textContent = shiftLead;
                syncToFirebase();
            });
            
            document.getElementById('stepup-lead-selector').addEventListener('change', (e) => {
                stepUpLead = e.target.value;
                document.getElementById('stepup-lead-display').textContent = stepUpLead;
                syncToFirebase();
            });
            
            document.getElementById('auto-populate-btn').addEventListener('click', () => {
                autoPopulateSchedule();
                syncToFirebase();
            });
        }

        function updateAvailableEngineers() {
            switch(currentTeam) {
                case 'A': availableEngineers = [...TEAMS.A, ...extraEngineers]; break;
                case 'B': availableEngineers = [...TEAMS.B, ...extraEngineers]; break;
                default: availableEngineers = [...TEAMS.A, ...TEAMS.B, ...extraEngineers];
            }
            updateExtraEngineerDropdown();
            updateEngineerOffDropdown();
        }

        function updateExtraEngineerDropdown() {
            const select = document.getElementById('extra-engineer-select');
            if (select) {
                select.innerHTML = '<option value="">Select Engineer for Extra Hours</option>';
                [...TEAMS.A, ...TEAMS.B].forEach(engineer => {
                    select.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                });
            }
        }

        function updateEngineerOffDropdown() {
            const select = document.getElementById('engineer-off-select');
            if (select) {
                select.innerHTML = '<option value="">Select Engineer Off</option>';
                availableEngineers.forEach(engineer => {
                    select.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                });
            }
        }

        function updateLeaderSelectors() {
            const allEngineers = [...TEAMS.A, ...TEAMS.B, ...extraEngineers];
            const shiftLeadSelect = document.getElementById('shift-lead-selector');
            const stepupLeadSelect = document.getElementById('stepup-lead-selector');
            
            if (shiftLeadSelect && stepupLeadSelect) {
                shiftLeadSelect.innerHTML = '<option value="">Select Shift Lead</option>';
                stepupLeadSelect.innerHTML = '<option value="">Select Step-up Lead</option>';
                allEngineers.forEach(engineer => {
                    shiftLeadSelect.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                    stepupLeadSelect.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                });
            }
        }

        function initializeScheduleData() {
            scheduleData = {};
            shiftLead = '';
            stepUpLead = '';
            TIME_SLOTS.forEach(slot => {
                scheduleData[slot.time] = {
                    skg: ['', '', '', '', '', ''],
                    textables: ['', '', '', '', '', '']
                };
            });
            // Clear shift lead displays
            if (document.getElementById('shift-lead-display')) document.getElementById('shift-lead-display').textContent = '';
            if (document.getElementById('stepup-lead-display')) document.getElementById('stepup-lead-display').textContent = '';
            if (document.getElementById('shift-lead-selector')) document.getElementById('shift-lead-selector').value = '';
            if (document.getElementById('stepup-lead-selector')) document.getElementById('stepup-lead-selector').value = '';
        }
        
        function startNewDay() {
            // Reset all schedule data
            initializeScheduleData();
            
            // Reset team settings
            currentTeam = 'A';
            availableEngineers = [...TEAMS.A];
            extraEngineers = [];
            engineersOff = [];
            
            // Clear user inputs (breaks and meetings from dashboard)
            userInputs = {};
            
            // Update displays
            if (document.getElementById('team-selector')) document.getElementById('team-selector').value = 'A';
            updateExtraEngineersDisplay();
            updateEngineersOffDisplay();
            updateDashboard();
            
            // Clear user inputs in Firebase
            if (firebaseInitialized) {
                userInputsRef.remove().catch(err => console.log('Clear user inputs failed:', err));
            }
            
            // Sync everything to Firebase
            syncToFirebase();
            
            alert('New day started! All data has been reset.');
        }

        function updateDashboard() {
            updateScheduleTable();
            updateLeaderSelectors();
        }

        function updateScheduleTable() {
            const tbody = document.getElementById('schedule-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            TIME_SLOTS.forEach(slot => {
                const row = document.createElement('tr');
                let html = `<td style="padding: 8px; border: 1px solid #000; font-weight: bold; text-align: center;">${slot.label}</td>`;
                
                // SKG columns (6)
                for (let i = 0; i < 6; i++) {
                    html += `<td style="padding: 4px; border: 1px solid #000;">
                        <select class="engineer-select" onchange="updateScheduleData('${slot.time}', 'skg', ${i}, this.value)">
                            <option value="">-</option>
                            ${getAvailableEngineersForSlot(slot.time, 'skg', i).map(eng =>
                                `<option value="${eng}" ${scheduleData[slot.time].skg[i] === eng ? 'selected' : ''}>${eng}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                }
                
                // Textables columns (6)
                for (let i = 0; i < 6; i++) {
                    html += `<td style="padding: 4px; border: 1px solid #000;">
                        <select class="engineer-select" onchange="updateScheduleData('${slot.time}', 'textables', ${i}, this.value)">
                            <option value="">-</option>
                            ${getAvailableEngineersForSlot(slot.time, 'textables', i).map(eng =>
                                `<option value="${eng}" ${scheduleData[slot.time].textables[i] === eng ? 'selected' : ''}>${eng}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                }
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
            
            updateLiveStatus();
            updateUserInputsDisplay();
        }

        function getAvailableEngineersForSlot(time, type, index) {
            const currentValue = scheduleData[time][type][index];
            return availableEngineers.filter(eng => {
                if (eng === currentValue) return true;
                if (engineersOff.includes(eng)) return false;
                const assignedToSkg = isEngineerAssigned(time, eng, 'skg');
                const assignedToTextables = isEngineerAssigned(time, eng, 'textables');
                if (type.includes('skg') && assignedToTextables) return false;
                if (type.includes('textables') && assignedToSkg) return false;
                return true;
            });
        }

        function isEngineerAssigned(time, engineer, category) {
            const data = scheduleData[time];
            if (category === 'skg') return data.skg.includes(engineer);
            if (category === 'textables') return data.textables.includes(engineer);
            return false;
        }

        function autoPopulateSchedule() {
            TIME_SLOTS.forEach((slot, timeIndex) => {
                scheduleData[slot.time].skg = ['', '', '', '', '', ''];
                scheduleData[slot.time].textables = ['', '', '', '', '', ''];
                
                // Get engineers not on break/meeting for this time slot
                const unavailableEngineers = getUnavailableEngineers(slot.time);
                const workingEngineers = availableEngineers.filter(eng => 
                    !engineersOff.includes(eng) && !unavailableEngineers.includes(eng)
                );
                
                const groupSize = Math.ceil(workingEngineers.length / 2);
                const group1 = workingEngineers.slice(0, groupSize);
                const group2 = workingEngineers.slice(groupSize);
                
                const skgGroup = timeIndex % 2 === 0 ? group1 : group2;
                const textablesGroup = timeIndex % 2 === 0 ? group2 : group1;
                
                // Assign SKG (ensure no conflicts)
                let skgAssigned = [];
                skgGroup.forEach((eng, i) => {
                    if (i < 6 && !skgAssigned.includes(eng)) {
                        scheduleData[slot.time].skg[i] = eng;
                        skgAssigned.push(eng);
                    }
                });
                
                // Assign Textables (ensure no conflicts with SKG)
                let textablesAssigned = [];
                textablesGroup.forEach((eng, i) => {
                    if (i < 6 && !skgAssigned.includes(eng) && !textablesAssigned.includes(eng)) {
                        scheduleData[slot.time].textables[i] = eng;
                        textablesAssigned.push(eng);
                    }
                });
            });
            
            updateDashboard();
        }
        
        function getUnavailableEngineers(timeSlot) {
            const unavailable = [];
            Object.values(userInputs || {}).forEach(input => {
                if (input.timeSlot === timeSlot && (input.type === 'break' || input.type === 'meeting')) {
                    unavailable.push(input.alias);
                }
            });
            return unavailable;
        }

        function updateLiveStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            let currentTimeSlot = '';
            
            if (currentHour >= 7 && currentHour < 15) {
                currentTimeSlot = `${currentHour}:00`;
            }
            
            const statusContent = document.getElementById('live-status-content');
            if (!statusContent) return;
            
            let statusHTML = `<div style="text-align: center; font-size: 20px; margin-bottom: 15px; color: #FF9900;">FOC ADMIN LIVE: TEAM ${currentTeam}</div>`;
            
            // Add shift lead and step-up lead info
            statusHTML += `<div style="text-align: center; margin-bottom: 15px;">`;
            statusHTML += `<div style="color: #FFD700; font-size: 14px;">Shift Lead: ${shiftLead || 'Not Set'}</div>`;
            statusHTML += `<div style="color: #FFD700; font-size: 14px;">Step-up Lead: ${stepUpLead || 'Not Set'}</div>`;
            statusHTML += `</div>`;
            
            if (currentTimeSlot && scheduleData[currentTimeSlot]) {
                const data = scheduleData[currentTimeSlot];
                const skgCount = data.skg.filter(eng => eng !== '').length;
                const textablesCount = data.textables.filter(eng => eng !== '').length;
                
                // Count user inputs for current slot
                const userBreaksCount = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === currentTimeSlot && input.type === 'break'
                ).length;
                const userMeetingsCount = Object.values(userInputs || {}).filter(input => 
                    input.timeSlot === currentTimeSlot && input.type === 'meeting'
                ).length;
                
                statusHTML += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">`;
                statusHTML += `<div>`;
                statusHTML += `<div style="color: #4CAF50; font-size: 16px; margin-bottom: 10px;">üìä CURRENT SLOT: ${currentTimeSlot}</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üîç SKG: ${skgCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üìù Textables: ${textablesCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">‚òï User Breaks: ${userBreaksCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üìÖ User Meetings: ${userMeetingsCount} Engineers</div>`;
                statusHTML += `</div>`;
                
                statusHTML += `<div>`;
                statusHTML += `<div style="color: #2196F3; font-size: 16px; margin-bottom: 10px;">üë• DASHBOARD STATS</div>`;
                statusHTML += `<div style="font-size: 14px;">`;
                statusHTML += `Total Active: ${skgCount + textablesCount} Engineers<br>`;
                statusHTML += `Total Out of OPS: ${userMeetingsCount + userBreaksCount} Engineers<br>`;
                statusHTML += `Dashboard Users: ${Object.keys(userInputs || {}).length} Inputs`;
                statusHTML += `</div>`;
                statusHTML += `</div>`;
                statusHTML += `</div>`;
            } else {
                statusHTML += `<div style="text-align: center; color: #FFB74D; font-size: 16px;">Outside operational hours (7:00-15:00)</div>`;
            }
            
            statusContent.innerHTML = statusHTML;
        }

        function startTimeClock() {
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', {
                    hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                const timeElement = document.getElementById('current-time');
                if (timeElement) timeElement.textContent = `Current Time: ${timeString}`;
                
                const currentHour = now.getHours();
                let currentTimeSlot = '';
                
                if (currentHour >= 7 && currentHour < 15) {
                    currentTimeSlot = `${currentHour}:00`;
                }
                
                document.querySelectorAll('.time-indicator').forEach(el => {
                    el.classList.remove('time-indicator');
                });
                
                if (currentTimeSlot) {
                    const rows = document.querySelectorAll('#schedule-tbody tr');
                    rows.forEach(row => {
                        const timeCell = row.cells[0];
                        if (timeCell && timeCell.textContent.trim() === currentTimeSlot) {
                            row.classList.add('time-indicator');
                        }
                    });
                }
                
                if (now.getSeconds() === 0) updateLiveStatus();
            }
            
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(updateLiveStatus, 60000);
        }

        // Global functions
        window.updateScheduleData = function(time, type, index, value) {
            if (type.includes('skg') && value && isEngineerAssigned(time, value, 'textables')) {
                alert('Engineers cannot be assigned to both SKG and Textables.');
                event.target.value = '';
                return;
            }
            if (type.includes('textables') && value && isEngineerAssigned(time, value, 'skg')) {
                alert('Engineers cannot be assigned to both SKG and Textables.');
                event.target.value = '';
                return;
            }
            scheduleData[time][type][index] = value;
            updateLiveStatus();
            syncToFirebase();
        };

        window.addExtraEngineer = function() {
            const select = document.getElementById('extra-engineer-select');
            const engineer = select.value;
            if (engineer && !extraEngineers.includes(engineer)) {
                extraEngineers.push(engineer);
                updateAvailableEngineers();
                updateExtraEngineersDisplay();
                updateScheduleTable();
                select.value = '';
                syncToFirebase();
            }
        };

        window.removeExtraEngineer = function(engineer) {
            extraEngineers = extraEngineers.filter(eng => eng !== engineer);
            updateAvailableEngineers();
            updateExtraEngineersDisplay();
            updateScheduleTable();
            syncToFirebase();
        };

        window.addEngineerOff = function() {
            const select = document.getElementById('engineer-off-select');
            const engineer = select.value;
            if (engineer && !engineersOff.includes(engineer)) {
                engineersOff.push(engineer);
                updateEngineersOffDisplay();
                updateScheduleTable();
                select.value = '';
                syncToFirebase();
            }
        };

        window.removeEngineerOff = function(engineer) {
            engineersOff = engineersOff.filter(eng => eng !== engineer);
            updateEngineersOffDisplay();
            updateScheduleTable();
            syncToFirebase();
        };

        function updateExtraEngineersDisplay() {
            const container = document.getElementById('extra-engineers-list');
            if (container) {
                container.innerHTML = extraEngineers.map(eng => 
                    `<span style="margin: 2px; padding: 4px 8px; background: #e3f2fd; border-radius: 4px; display: inline-block;">
                        ${eng} <button onclick="removeExtraEngineer('${eng}')" style="background: #f44336; color: white; border: none; border-radius: 2px; margin-left: 4px; cursor: pointer;">√ó</button>
                    </span>`
                ).join('');
            }
        }

        function updateEngineersOffDisplay() {
            const container = document.getElementById('engineers-off-list');
            if (container) {
                container.innerHTML = engineersOff.map(eng => 
                    `<span style="margin: 2px; padding: 4px 8px; background: #ffebee; border-radius: 4px; display: inline-block;">
                        ${eng} <button onclick="removeEngineerOff('${eng}')" style="background: #f44336; color: white; border: none; border-radius: 2px; margin-left: 4px; cursor: pointer;">√ó</button>
                    </span>`
                ).join('');
            }
        }

        function logout() {
            isAuthenticated = false;
            showLogin();
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (isAuthenticated) {
                initDashboard();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
