<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOC Admin - Create Schedule</title>
    <style>
        * { box-sizing: border-box; }
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --skg-color: #8e44ad;
            --textables-color: #e67e22;
            --break-color: #34c759;
            --meeting-color: #ff3b30;
            --border-color: rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --border-color: rgba(255,255,255,0.1);
        }
        body { margin: 0; padding: 0; background: var(--bg-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: var(--text-primary); transition: all 0.3s ease; }
        .header { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; position: relative; }
        [data-theme="dark"] .header { background: rgba(44,44,46,0.8); }
        .theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 8px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s ease; }
        .theme-toggle:hover { transform: translateY(-1px); }
        .header-title { text-align: center; padding: 20px 0; margin: 0; font-size: 28px; font-weight: 600; color: #007aff; }
        .nav-tabs { display: flex; justify-content: center; background: transparent; padding: 0 20px 20px; }
        .nav-tab { padding: 12px 24px; color: #86868b; text-decoration: none; border-radius: 20px; transition: all 0.3s ease; margin: 0 8px; font-weight: 500; }
        .nav-tab:hover { background: rgba(0,122,255,0.1); color: #007aff; }
        .nav-tab.active { background: #007aff; color: white; }
        .main-content { padding: 20px; max-width: 1400px; margin: 0 auto; }
        .time-indicator { background: rgba(255,149,0,0.1) !important; border-left: 4px solid #ff9500 !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .engineer-select { width: 80px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 11px; background: var(--bg-secondary); color: var(--text-primary); }
        .status-online { color: #34c759; font-weight: 600; }
        .status-offline { color: #ff3b30; font-weight: 600; }
        .card { background: var(--bg-secondary); border-radius: 16px; padding: 24px; margin: 16px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .btn { padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; }
        .btn-primary { background: #007aff; color: white; }
        .btn-primary:hover { background: #0056cc; transform: translateY(-1px); }
        .btn-success { background: #34c759; color: white; }
        .btn-success:hover { background: #28a745; transform: translateY(-1px); }
        .btn-danger { background: #ff3b30; color: white; }
        .btn-danger:hover { background: #d70015; transform: translateY(-1px); }
        .input-select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; }
        .table-container { background: var(--bg-secondary); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .schedule-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .schedule-table th, .schedule-table td { padding: 12px 8px; border: 1px solid var(--border-color); text-align: center; }
        .schedule-table th { background: var(--bg-primary); font-weight: 600; color: var(--text-primary); }
        .schedule-table .time-cell { background: var(--bg-primary); font-weight: 600; color: var(--text-primary); position: sticky; left: 0; z-index: 10; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .live-status { background: linear-gradient(135deg, #007aff 0%, #5856d6 100%); color: white; border-radius: 20px; padding: 32px; text-align: center; box-shadow: 0 8px 32px rgba(0,122,255,0.3); }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 20px; }
        .status-item { background: rgba(255,255,255,0.15); padding: 16px; border-radius: 12px; backdrop-filter: blur(10px); }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            <div id="viewer-count" style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: var(--text-secondary); position: relative; cursor: pointer;">
                <span>üëÅÔ∏è</span>
                <span id="viewer-number">0</span>
                <div id="viewer-tooltip" style="display: none; position: absolute; top: 100%; left: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 150px; font-size: 12px;"></div>
            </div>
        </div>
        <h1 class="header-title">DUB Shift Planner</h1>
        <div class="nav-tabs">
            <a href="dashboard.html" class="nav-tab">Dashboard</a>
            <a href="index.html" class="nav-tab active">Create Schedule</a>
        </div>
    </div>
    <div id="app"></div>
    <script>
        const TEAMS = {
            A: ['azjimene', 'ddunwood', 'xnevpaul', 'ssanthag', 'mwanyali', 'andrwmn', 'mcdlvega'],
            B: ['criiliof', 'almelvio', 'rowhitei', 'tansthef', 'tracykie', 'shlakshy', 'kellyerd', 'ferreved']
        };
        const TIME_SLOTS = [
            { time: '07:00', label: '7:00' }, { time: '08:00', label: '8:00' }, { time: '09:00', label: '9:00' },
            { time: '10:00', label: '10:00' }, { time: '11:00', label: '11:00' }, { time: '12:00', label: '12:00' },
            { time: '13:00', label: '13:00' }, { time: '14:00', label: '14:00' }
        ];
        
        let currentTeam = '', availableEngineers = [], extraEngineers = [], engineersOff = [], scheduleData = {}, shiftLead = '', stepUpLead = '', userInputs = {};
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDIF_gb3swfMlXFa4ZY4ZsoAZSwaqmiwm4",
            authDomain: "foc-dashboard.firebaseapp.com",
            databaseURL: "https://foc-dashboard-default-rtdb.firebaseio.com",
            projectId: "foc-dashboard",
            storageBucket: "foc-dashboard.firebasestorage.app",
            messagingSenderId: "869888485796",
            appId: "1:869888485796:web:82bf668dbfdc9c17a1f931"
        };
        
        let firebaseInitialized = false;
        let database, scheduleRef, userInputsRef;
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            scheduleRef = database.ref('schedule');
            userInputsRef = database.ref('userInputs');
            firebaseInitialized = true;
            
            // Setup viewer tracking
            setupViewerTracking();
        } catch (error) {
            firebaseInitialized = false;
        }
        
        // Real-time sync functions
        function syncToFirebase() {
            if (!firebaseInitialized) return;
            const data = { 
                currentTeam, 
                availableEngineers, 
                extraEngineers, 
                engineersOff, 
                scheduleData, 
                shiftLead, 
                stepUpLead, 
                lastUpdated: Date.now() 
            };
            console.log('Admin syncing to Firebase:', data);
            scheduleRef.set(data).then(() => {
                console.log('Admin sync successful');
                window.lastUpdate = data.lastUpdated;
            }).catch(err => {
                console.error('Admin sync failed:', err);
            });
        }
        
        function loadExistingData() {
            return new Promise((resolve) => {
                if (!firebaseInitialized) {
                    console.log('Firebase not initialized, using empty data');
                    initializeScheduleData();
                    resolve();
                    return;
                }
                
                console.log('Loading existing data from Firebase...');
                
                // Load schedule data
                scheduleRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        console.log('Loaded existing schedule data:', data);
                        currentTeam = data.currentTeam || '';
                        availableEngineers = data.availableEngineers || [];
                        extraEngineers = data.extraEngineers || [];
                        engineersOff = data.engineersOff || [];
                        scheduleData = data.scheduleData || {};
                        shiftLead = data.shiftLead || '';
                        stepUpLead = data.stepUpLead || '';
                        window.lastUpdate = data.lastUpdated;
                        
                        // If no schedule data exists, initialize empty
                        if (Object.keys(scheduleData).length === 0) {
                            initializeScheduleData();
                        }
                    } else {
                        console.log('No existing schedule data, initializing empty');
                        initializeScheduleData();
                    }
                    
                    // Load user inputs
                    return userInputsRef.once('value');
                }).then((snapshot) => {
                    const data = snapshot.val();
                    userInputs = data || {};
                    console.log('Loaded existing user inputs:', userInputs);
                    resolve();
                }).catch((error) => {
                    console.error('Error loading existing data:', error);
                    initializeScheduleData();
                    resolve();
                });
            });
        }
        
        function setupRealtimeSync() {
            if (!firebaseInitialized) return;
            
            console.log('Admin: Setting up Firebase listeners...');
            
            scheduleRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Admin received schedule data:', data);
                if (data && data.lastUpdated !== window.lastUpdate) {
                    currentTeam = data.currentTeam || '';
                    availableEngineers = data.availableEngineers || [];
                    extraEngineers = data.extraEngineers || [];
                    engineersOff = data.engineersOff || [];
                    scheduleData = data.scheduleData || {};
                    shiftLead = data.shiftLead || '';
                    stepUpLead = data.stepUpLead || '';
                    window.lastUpdate = data.lastUpdated;
                    updateDisplayFromSync();
                    updateLiveStatus(); // Force live status update
                }
            });
            
            // Listen to user inputs from dashboard
            userInputsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Admin received user inputs:', data);
                userInputs = data || {};
                updateUserInputsDisplay();
                updateLiveStatus(); // Update live status when user inputs change
            });
        }
        
        function updateDisplayFromSync() {
            if (document.getElementById('team-selector')) {
                document.getElementById('team-selector').value = currentTeam;
                // Trigger team change to update dropdowns
                updateAvailableEngineers();
                updateLeaderSelectors();
            }
            if (document.getElementById('shift-lead-display')) document.getElementById('shift-lead-display').textContent = shiftLead;
            if (document.getElementById('stepup-lead-display')) document.getElementById('stepup-lead-display').textContent = stepUpLead;
            updateExtraEngineersDisplay();
            updateEngineersOffDisplay();
            updateScheduleTable();
        }
        
        let isAuthenticated = false;
        
        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: calc(100vh - 120px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="background: var(--bg-secondary); padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); max-width: 400px; width: 100%; border: 1px solid var(--border-color);">
                        <h2 style="text-align: center; color: var(--text-primary); margin-bottom: 30px;">üîê Admin Access</h2>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-primary);">Username:</label>
                            <input type="text" id="username" placeholder="Enter username" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-primary);">Password:</label>
                            <input type="password" id="password" placeholder="Enter password" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <button onclick="login()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">Login</button>
                        <div style="text-align: center;">
                            <a href="dashboard.html" style="color: #007bff; text-decoration: none;">üìä View Public Dashboard</a>
                        </div>
                    </div>
                </div>`;
        }
        
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            const validUsers = {
                'admin': 'foc2024',
                'shiftlead': 'lead123',
                'manager': 'mgr456',
                'ferreved': 'foc2024',
                'xnevpaul': 'foc2024',
                'kellyerd': 'foc2024',
                'saudere': 'foc2024',
                'wunderd': 'foc2024',
                'criiliof': 'foc2024',
                'shlakshy': 'foc2024',
                'pjmaguir': 'foc2024',
                'ssanthag': 'foc2024'
            };
            
            if (validUsers[username] === password) {
                isAuthenticated = true;
                currentUsername = username;
                initDashboard();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        }
        
        let currentUsername = '';
        let myViewerRef = null;
        let editHistory = [];
        
        function addToEditHistory(action, details) {
            const timestamp = new Date().toLocaleTimeString('en-GB', {
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            
            editHistory.unshift({
                user: currentUsername,
                action: action,
                details: details,
                timestamp: timestamp
            });
            
            // Keep only last 20 entries
            if (editHistory.length > 20) {
                editHistory = editHistory.slice(0, 20);
            }
            
            updateEditHistoryDisplay();
        }
        
        function updateEditHistoryDisplay() {
            const container = document.getElementById('edit-history-display');
            if (!container) return;
            
            if (editHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No edits yet.</p>';
                return;
            }
            
            const historyHTML = editHistory.map(entry => `
                <div style="margin-bottom: 10px; padding: 8px; background: var(--bg-primary); border-radius: 6px; border-left: 3px solid #007aff;">
                    <div style="font-weight: 600; color: #007aff; font-size: 12px;">${entry.user} - ${entry.timestamp}</div>
                    <div style="font-size: 13px; margin-top: 4px;">${entry.details}</div>
                </div>
            `).join('');
            
            container.innerHTML = historyHTML;
        }
        
        function setupViewerTracking() {
            if (!firebaseInitialized || !currentUsername) return;
            
            const viewersRef = database.ref('viewers/admin');
            myViewerRef = viewersRef.push();
            
            // Set myself as online with username
            myViewerRef.set({
                username: currentUsername,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                page: 'admin',
                lastActivity: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Remove myself when I disconnect
            myViewerRef.onDisconnect().remove();
            
            // Listen for viewer changes
            viewersRef.on('value', (snapshot) => {
                const viewers = snapshot.val();
                const count = viewers ? Object.keys(viewers).length : 0;
                const viewerElement = document.getElementById('viewer-number');
                const tooltipElement = document.getElementById('viewer-tooltip');
                
                if (viewerElement) {
                    viewerElement.textContent = count;
                }
                
                if (tooltipElement && viewers) {
                    const userList = Object.values(viewers)
                        .map(viewer => `‚Ä¢ ${viewer.username}`)
                        .join('<br>');
                    tooltipElement.innerHTML = `<strong>Active Editors:</strong><br>${userList}`;
                }
            });
            
            // Setup hover events
            const viewerCount = document.getElementById('viewer-count');
            const tooltip = document.getElementById('viewer-tooltip');
            
            if (viewerCount && tooltip) {
                viewerCount.addEventListener('mouseenter', () => {
                    tooltip.style.display = 'block';
                });
                
                viewerCount.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            }
        }
        
        function updateUserActivity() {
            if (myViewerRef && firebaseInitialized) {
                myViewerRef.update({
                    lastActivity: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        function initDashboard() {
            if (!isAuthenticated) {
                showLogin();
                return;
            }
            
            // Load existing data from Firebase first, then setup real-time sync
            loadExistingData().then(() => {
                setupRealtimeSync();
            });
            document.getElementById('app').innerHTML = `
                <div class="main-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <h1 style="color: var(--text-primary); margin: 0; font-size: 32px; font-weight: 700;">Create Schedule</h1>
                        <div style="display: flex; gap: 12px;">
                            <a href="dashboard.html" target="_blank" class="btn btn-success" style="text-decoration: none;">üìä View Dashboard</a>
                            <button onclick="logout()" class="btn btn-danger">Logout</button>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                            <button id="reset-all-btn" class="btn btn-danger">Create New Schedule</button>
                            <div style="display: flex; align-items: center; gap: 8px;"><label style="font-weight: 600;">Team:</label><select id="team-selector" class="input-select">
                                <option value="">Select Team</option>
                                <option value="A">Team A</option><option value="B">Team B</option>
                                <option value="A_PROJECT_B">Team A Project for B</option><option value="B_PROJECT_A">Team B Project for A</option>
                            </select></div>
                            <button id="auto-populate-btn" class="btn btn-primary">Auto Populate</button>

                            <button onclick="publishSchedule()" class="btn btn-success">Publish to Dashboard</button>
                        </div>
                        <div id="current-time" style="text-align: center; font-size: 20px; font-weight: 600; color: var(--text-primary); background: rgba(0,122,255,0.1); padding: 12px; border-radius: 12px;"></div>
                        
                        <!-- Leadership Selection -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div style="background: rgba(0,122,255,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(0,122,255,0.2);">
                                <h4 style="margin: 0 0 12px 0; color: #007aff; font-size: 16px; font-weight: 600;"> Shift Lead</h4>
                                <select id="shift-lead-selector" class="input-select" style="width: 100%; margin-bottom: 8px;">
                                    <option value="">Select Shift Lead</option>
                                </select>
                                <div id="shift-lead-display" style="font-size: 14px; font-weight: 600; color: #007aff; min-height: 20px;">Not Selected</div>
                            </div>
                            <div style="background: rgba(88,86,214,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(88,86,214,0.2);">
                                <h4 style="margin: 0 0 12px 0; color: #5856d6; font-size: 16px; font-weight: 600;">Step-up Lead</h4>
                                <select id="stepup-lead-selector" class="input-select" style="width: 100%; margin-bottom: 8px;">
                                    <option value="">Select Step-up Lead</option>
                                </select>
                                <div id="stepup-lead-display" style="font-size: 14px; font-weight: 600; color: #5856d6; min-height: 20px;">Not Selected</div>
                            </div>
                        </div>
                        <!-- Engineer Management -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                            <div style="background: rgba(52,199,89,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(52,199,89,0.2);">
                                <h4 style="margin: 0 0 12px 0; color: #34c759; font-size: 16px; font-weight: 600;">‚ûï Extra Engineers</h4>
                                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                    <select id="extra-engineer-select" class="input-select" style="flex: 1;">
                                        <option value="">Select Engineer for Extra Hours</option>
                                    </select>
                                    <button onclick="addExtraEngineer()" class="btn btn-success" style="padding: 8px 16px;">Add</button>
                                </div>
                                <div id="extra-engineers-list" style="min-height: 40px;"></div>
                            </div>
                            <div style="background: rgba(255,59,48,0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,59,48,0.2);">
                                <h4 style="margin: 0 0 12px 0; color: #ff3b30; font-size: 16px; font-weight: 600;">‚ùå Engineers Off</h4>
                                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                    <select id="engineer-off-select" class="input-select" style="flex: 1;">
                                        <option value="">Select Engineer Off</option>
                                    </select>
                                    <button onclick="addEngineerOff()" class="btn btn-danger" style="padding: 8px 16px;">Add</button>
                                </div>
                                <div id="engineers-off-list" style="min-height: 40px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container" style="overflow-x: auto;">
                        <table class="schedule-table">

                            <tr><th class="time-cell" style="background: rgba(255,149,0,0.1);">06:00 to 07:00</th><td colspan="12" style="background: rgba(255,149,0,0.1); font-weight: 600;">Project Hour</td></tr>
                            <tr><td colspan="13" style="padding: 4px; border: none;"></td></tr>
                            <tr><th></th>
                            <th id="skg-header" colspan="6" style="background: rgba(142,68,173,0.1); color: var(--skg-color);">üõ∞Ô∏è Raiding SKG</th>
                            <th id="textables-header" colspan="6" style="background: rgba(230,126,34,0.1); color: var(--textables-color);">üõ∞Ô∏è Textables and FOC slack requests</th></tr>
                            <tr id="eng-header"><th class="time-cell">Primary</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 1</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 2</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 3</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 4</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 5</th>
                            <th style="background: rgba(142,68,173,0.1);">Eng 6</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 1</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 2</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 3</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 4</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 5</th>
                            <th style="background: rgba(230,126,34,0.1);">Eng 6</th></tr>
                            <tbody id="schedule-tbody"></tbody>
                            <tr><th class="time-cell" style="background: rgba(255,149,0,0.1);">15:00 to 16:00</th><td colspan="12" style="background: rgba(255,149,0,0.1); font-weight: 600;">Project Hour</td></tr>
                        </table>
                    </div>
                    
                    <!-- User Inputs and Edit History -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="card">
                            <h3 style="color: var(--text-primary); margin-top: 0; font-size: 20px; font-weight: 600;">üìù Live User Inputs from Dashboard</h3>
                            <div id="user-inputs-display" style="font-size: 14px;"></div>
                        </div>
                        <div class="card">
                            <h3 style="color: var(--text-primary); margin-top: 0; font-size: 20px; font-weight: 600;">üìã Edit History</h3>
                            <div id="edit-history-display" style="font-size: 14px; max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <div class="live-status">
                        <h2 style="margin-bottom: 24px; font-size: 28px; font-weight: 700;">FOC LIVE STATUS</h2>
                        <div id="live-status-content" style="font-size: 16px; line-height: 1.6;"></div>
                    </div>
                </div>`;
            attachEventListeners();
            updateDashboard();
            updateExtraEngineerDropdown();
            updateEngineerOffDropdown();
            startTimeClock();
        }
        
        function publishSchedule() {
            updateUserActivity(); // Track user activity
            
            if (confirm('Publish current schedule to dashboard? This will make it visible to all users.')) {
                addToEditHistory('Publish', `Published schedule for Team ${currentTeam} to dashboard`);
                syncToFirebase();
                alert('Schedule published successfully! ‚úÖ');
            }
        }
        
        function updateUserInputsDisplay() {
            const container = document.getElementById('user-inputs-display');
            if (!container) return;
            
            const inputs = Object.entries(userInputs || {});
            if (inputs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No user inputs yet.</p>';
                return;
            }
            
            const groupedInputs = {};
            inputs.forEach(([key, input]) => {
                if (!groupedInputs[input.timeSlot]) {
                    groupedInputs[input.timeSlot] = [];
                }
                groupedInputs[input.timeSlot].push({...input, key});
            });
            
            let html = '';
            Object.keys(groupedInputs).sort().forEach(timeSlot => {
                html += `<div style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 4px; border-left: 4px solid #007bff;">`;
                html += `<strong style="color: #007bff;">${timeSlot}</strong><br>`;
                groupedInputs[timeSlot].forEach(input => {
                    const icon = input.type === 'break' ? '‚òï' : 'üìÖ';
                    const color = input.type === 'break' ? '#28a745' : '#dc3545';
                    html += `<div style="display: flex; align-items: center; justify-content: space-between; margin: 5px 0; padding: 5px; background: rgba(0,0,0,0.05); border-radius: 4px;">`;
                    html += `<span style="color: ${color};">${icon} ${input.alias} - ${input.type === 'break' ? input.duration : input.reason + ' (' + input.duration + ')'}</span>`;
                    html += `<button onclick="removeUserInput('${input.key}')" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">Remove</button>`;
                    html += `</div>`;
                });
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }

        function attachEventListeners() {
            document.getElementById('reset-all-btn').addEventListener('click', () => {
                resetAllData();
            });
            
            document.getElementById('team-selector').addEventListener('change', (e) => {
                currentTeam = e.target.value;
                updateAvailableEngineers();
                updateLeaderSelectors();
                initializeScheduleData(); // Reinitialize with correct array sizes
                updateDashboard();
                syncToFirebase();
            });
            
            document.getElementById('shift-lead-selector').addEventListener('change', (e) => {
                const oldLead = shiftLead;
                shiftLead = e.target.value;
                document.getElementById('shift-lead-display').textContent = shiftLead;
                
                if (shiftLead && shiftLead !== oldLead) {
                    addToEditHistory('Leadership Change', `Set Shift Lead to ${shiftLead}`);
                }
                
                console.log('Shift lead changed to:', shiftLead);
                syncToFirebase();
            });
            
            document.getElementById('stepup-lead-selector').addEventListener('change', (e) => {
                const oldLead = stepUpLead;
                stepUpLead = e.target.value;
                document.getElementById('stepup-lead-display').textContent = stepUpLead;
                
                if (stepUpLead && stepUpLead !== oldLead) {
                    addToEditHistory('Leadership Change', `Set Step-up Lead to ${stepUpLead}`);
                }
                
                console.log('Step-up lead changed to:', stepUpLead);
                syncToFirebase();
            });
            
            document.getElementById('auto-populate-btn').addEventListener('click', () => {
                autoPopulateSchedule();
                addToEditHistory('Auto Populate', `Auto-populated schedule for Team ${currentTeam}`);
                updateLiveStatus();
                syncToFirebase();
            });
        }

        function updateAvailableEngineers() {
            switch(currentTeam) {
                case 'A': availableEngineers = [...TEAMS.A, ...extraEngineers]; break;
                case 'B': availableEngineers = [...TEAMS.B, ...extraEngineers]; break;
                case 'A_PROJECT_B': availableEngineers = [...TEAMS.A, ...TEAMS.B, ...extraEngineers]; break;
                case 'B_PROJECT_A': availableEngineers = [...TEAMS.A, ...TEAMS.B, ...extraEngineers]; break;
                default: availableEngineers = [];
            }
            updateExtraEngineerDropdown();
            updateEngineerOffDropdown();
        }

        function updateExtraEngineerDropdown() {
            const select = document.getElementById('extra-engineer-select');
            if (select) {
                select.innerHTML = '<option value="">Select Engineer for Extra Hours</option>';
                let availableForExtra = [];
                
                switch(currentTeam) {
                    case 'A': availableForExtra = [...TEAMS.B]; break; // Team A can add Team B engineers
                    case 'B': availableForExtra = [...TEAMS.A]; break; // Team B can add Team A engineers
                    case 'A_PROJECT_B':
                    case 'B_PROJECT_A': availableForExtra = [...TEAMS.A, ...TEAMS.B]; break; // Project teams can add all
                    default: availableForExtra = []; // No team selected
                }
                
                availableForExtra.forEach(engineer => {
                    if (!extraEngineers.includes(engineer)) {
                        select.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                    }
                });
            }
        }

        function updateEngineerOffDropdown() {
            const select = document.getElementById('engineer-off-select');
            if (select) {
                select.innerHTML = '<option value="">Select Engineer Off</option>';
                let availableForOff = [];
                
                switch(currentTeam) {
                    case 'A': availableForOff = [...TEAMS.A, ...extraEngineers]; break; // Team A can mark Team A + extra as off
                    case 'B': availableForOff = [...TEAMS.B, ...extraEngineers]; break; // Team B can mark Team B + extra as off
                    case 'A_PROJECT_B':
                    case 'B_PROJECT_A': availableForOff = [...TEAMS.A, ...TEAMS.B, ...extraEngineers]; break; // Project teams can mark all as off
                    default: availableForOff = []; // No team selected
                }
                
                availableForOff.forEach(engineer => {
                    if (!engineersOff.includes(engineer)) {
                        select.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                    }
                });
            }
        }

        function updateLeaderSelectors() {
            const allEngineers = [...TEAMS.A, ...TEAMS.B, ...extraEngineers];
            const shiftLeadSelect = document.getElementById('shift-lead-selector');
            const stepupLeadSelect = document.getElementById('stepup-lead-selector');
            
            if (shiftLeadSelect && stepupLeadSelect) {
                shiftLeadSelect.innerHTML = '<option value="">Select Shift Lead</option>';
                stepupLeadSelect.innerHTML = '<option value="">Select Step-up Lead</option>';
                allEngineers.forEach(engineer => {
                    shiftLeadSelect.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                    stepupLeadSelect.innerHTML += `<option value="${engineer}">${engineer}</option>`;
                });
            }
        }

        function initializeScheduleData() {
            scheduleData = {};
            shiftLead = '';
            stepUpLead = '';
            TIME_SLOTS.forEach(slot => {
                const isProjectTeam = currentTeam === 'A_PROJECT_B' || currentTeam === 'B_PROJECT_A';
                scheduleData[slot.time] = {
                    skg: new Array(isProjectTeam ? 10 : 6).fill(''),
                    textables: new Array(isProjectTeam ? 10 : 6).fill('')
                };
            });
            // Clear shift lead displays
            if (document.getElementById('shift-lead-display')) document.getElementById('shift-lead-display').textContent = '';
            if (document.getElementById('stepup-lead-display')) document.getElementById('stepup-lead-display').textContent = '';
            if (document.getElementById('shift-lead-selector')) document.getElementById('shift-lead-selector').value = '';
            if (document.getElementById('stepup-lead-selector')) document.getElementById('stepup-lead-selector').value = '';
        }
        
        function resetAllData() {
            if (!confirm('Are you sure you want to create a new schedule? This will clear ALL existing data including schedule, breaks, meetings, and edit history.')) {
                return;
            }
            
            // Reset all schedule data
            initializeScheduleData();
            
            // Reset team settings
            currentTeam = '';
            availableEngineers = [];
            extraEngineers = [];
            engineersOff = [];
            
            // Clear user inputs (breaks and meetings from dashboard)
            userInputs = {};
            
            // Clear edit history
            editHistory = [];
            updateEditHistoryDisplay();
            
            // Update displays
            if (document.getElementById('team-selector')) document.getElementById('team-selector').value = '';
            updateExtraEngineersDisplay();
            updateEngineersOffDisplay();
            updateDashboard();
            
            // Clear user inputs in Firebase
            if (firebaseInitialized) {
                userInputsRef.remove().catch(err => console.log('Clear user inputs failed:', err));
            }
            
            // Sync everything to Firebase (this will clear all data in Firebase)
            syncToFirebase();
            
            // Force update displays
            updateLiveStatus();
            
            addToEditHistory('Reset', 'Created new schedule - all data cleared');
            
            alert('New schedule created! All previous data has been cleared.');
        }

        function updateDashboard() {
            updateScheduleTable();
            updateLeaderSelectors();
        }

        function updateScheduleTable() {
            const tbody = document.getElementById('schedule-tbody');
            if (!tbody) return;
            
            const isProjectTeam = currentTeam === 'A_PROJECT_B' || currentTeam === 'B_PROJECT_A';
            const colCount = isProjectTeam ? 10 : 6;
            
            // Update table headers for project teams
            const skgHeader = document.getElementById('skg-header');
            const textablesHeader = document.getElementById('textables-header');
            const engHeader = document.getElementById('eng-header');
            
            if (skgHeader && textablesHeader && engHeader) {
                skgHeader.setAttribute('colspan', colCount);
                textablesHeader.setAttribute('colspan', colCount);
                
                // Update engineer header row
                let headerHTML = '<th class="time-cell">Primary</th>';
                for (let i = 1; i <= colCount; i++) {
                    headerHTML += `<th style="background: rgba(142,68,173,0.1);">Eng ${i}</th>`;
                }
                for (let i = 1; i <= colCount; i++) {
                    headerHTML += `<th style="background: rgba(230,126,34,0.1);">Eng ${i}</th>`;
                }
                engHeader.innerHTML = headerHTML;
            }
            
            tbody.innerHTML = '';
            TIME_SLOTS.forEach(slot => {
                // Ensure schedule data has correct array size
                if (!scheduleData[slot.time] || scheduleData[slot.time].skg.length !== colCount) {
                    scheduleData[slot.time] = {
                        skg: new Array(colCount).fill(''),
                        textables: new Array(colCount).fill('')
                    };
                }
                
                const row = document.createElement('tr');
                let html = `<th class="time-cell">${slot.label}</th>`;
                
                // SKG columns
                for (let i = 0; i < colCount; i++) {
                    html += `<td style="background: rgba(142,68,173,0.05);">
                        <select class="engineer-select" onchange="updateScheduleData('${slot.time}', 'skg', ${i}, this.value)">
                            <option value="">-</option>
                            ${getAvailableEngineersForSlot(slot.time, 'skg', i).map(eng =>
                                `<option value="${eng}" ${scheduleData[slot.time].skg[i] === eng ? 'selected' : ''}>${eng}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                }
                
                // Textables columns
                for (let i = 0; i < colCount; i++) {
                    html += `<td style="background: rgba(230,126,34,0.05);">
                        <select class="engineer-select" onchange="updateScheduleData('${slot.time}', 'textables', ${i}, this.value)">
                            <option value="">-</option>
                            ${getAvailableEngineersForSlot(slot.time, 'textables', i).map(eng =>
                                `<option value="${eng}" ${scheduleData[slot.time].textables[i] === eng ? 'selected' : ''}>${eng}</option>`
                            ).join('')}
                        </select>
                    </td>`;
                }
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
            
            updateLiveStatus();
            updateUserInputsDisplay();
        }

        function getAvailableEngineersForSlot(time, type, index) {
            const currentValue = scheduleData[time][type][index];
            return availableEngineers.filter(eng => {
                if (eng === currentValue) return true;
                if (engineersOff.includes(eng)) return false;
                const assignedToSkg = isEngineerAssigned(time, eng, 'skg');
                const assignedToTextables = isEngineerAssigned(time, eng, 'textables');
                if (type.includes('skg') && assignedToTextables) return false;
                if (type.includes('textables') && assignedToSkg) return false;
                return true;
            });
        }

        function isEngineerAssigned(time, engineer, category) {
            const data = scheduleData[time];
            if (category === 'skg') return data.skg.includes(engineer);
            if (category === 'textables') return data.textables.includes(engineer);
            return false;
        }

        function autoPopulateSchedule() {
            // Get engineers not on break/meeting
            const workingEngineers = availableEngineers.filter(eng => !engineersOff.includes(eng));
            
            TIME_SLOTS.forEach((slot, timeIndex) => {
                const isProjectTeam = currentTeam === 'A_PROJECT_B' || currentTeam === 'B_PROJECT_A';
                const colCount = isProjectTeam ? 10 : 6;
                scheduleData[slot.time].skg = new Array(colCount).fill('');
                scheduleData[slot.time].textables = new Array(colCount).fill('');
                
                // Remove engineers who have breaks/meetings for this specific time slot
                const unavailableEngineers = getUnavailableEngineers(slot.time);
                let availableForThisSlot = workingEngineers.filter(eng => !unavailableEngineers.includes(eng));
                
                // Apply project team restrictions
                const slotHour = parseInt(slot.time.split(':')[0]);
                if (currentTeam === 'A_PROJECT_B' && slotHour < 10) {
                    // Use only Team A engineers until 9 AM
                    availableForThisSlot = availableForThisSlot.filter(eng => TEAMS.A.includes(eng) || extraEngineers.includes(eng));
                } else if (currentTeam === 'B_PROJECT_A' && slotHour < 10) {
                    // Use only Team B engineers until 9 AM
                    availableForThisSlot = availableForThisSlot.filter(eng => TEAMS.B.includes(eng) || extraEngineers.includes(eng));
                }
                // From 10 AM onwards, both project teams use all available engineers
                
                // Calculate SKG and Textables sizes - alternate which gets the extra engineer
                const halfSize = Math.floor(availableForThisSlot.length / 2);
                const hasOddNumber = availableForThisSlot.length % 2 === 1;
                
                // Alternate which team gets the extra engineer each hour
                const skgGetsExtra = timeIndex % 2 === 0; // Even hours (0,2,4...) SKG gets extra, odd hours Textables gets extra
                
                const skgSize = hasOddNumber && skgGetsExtra ? halfSize + 1 : halfSize;
                const textablesSize = hasOddNumber && !skgGetsExtra ? halfSize + 1 : halfSize;
                
                let skgEngineers = [];
                let textablesEngineers = [];
                
                // Assign engineers alternating between SKG and Textables each hour
                // First, handle engineers who must rotate (were in previous slot)
                availableForThisSlot.forEach((eng) => {
                    const prevSlotIndex = timeIndex - 1;
                    let wasInSkg = false, wasInTextables = false;
                    
                    if (prevSlotIndex >= 0) {
                        const prevSlot = TIME_SLOTS[prevSlotIndex];
                        const prevData = scheduleData[prevSlot.time];
                        wasInSkg = prevData.skg.includes(eng);
                        wasInTextables = prevData.textables.includes(eng);
                    }
                    
                    // Force rotation: if was in SKG, must go to Textables (if space)
                    if (wasInSkg && textablesEngineers.length < textablesSize) {
                        textablesEngineers.push(eng);
                    }
                    // Force rotation: if was in Textables, must go to SKG (if space)
                    else if (wasInTextables && skgEngineers.length < skgSize) {
                        skgEngineers.push(eng);
                    }
                });
                
                // Then fill remaining spots with unassigned engineers
                availableForThisSlot.forEach((eng) => {
                    if (!skgEngineers.includes(eng) && !textablesEngineers.includes(eng)) {
                        // Fill remaining spots, alternating priority based on hour
                        if (skgGetsExtra) {
                            if (skgEngineers.length < skgSize) {
                                skgEngineers.push(eng);
                            } else if (textablesEngineers.length < textablesSize) {
                                textablesEngineers.push(eng);
                            }
                        } else {
                            if (textablesEngineers.length < textablesSize) {
                                textablesEngineers.push(eng);
                            } else if (skgEngineers.length < skgSize) {
                                skgEngineers.push(eng);
                            }
                        }
                    }
                });
                
                // Assign to schedule (max based on team type)
                const maxCols = isProjectTeam ? 10 : 6;
                skgEngineers.forEach((eng, i) => {
                    if (i < maxCols) scheduleData[slot.time].skg[i] = eng;
                });
                textablesEngineers.forEach((eng, i) => {
                    if (i < maxCols) scheduleData[slot.time].textables[i] = eng;
                });
            });
            
            updateDashboard();
        }
        
        function getUnavailableEngineers(timeSlot) {
            const unavailable = [];
            Object.values(userInputs || {}).forEach(input => {
                if (input.timeSlot === timeSlot && (input.type === 'break' || input.type === 'meeting')) {
                    unavailable.push(input.alias);
                }
            });
            return unavailable;
        }
        


        function updateLiveStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentTimeSlot = `${currentHour.toString().padStart(2, '0')}:00`;
            
            const statusContent = document.getElementById('live-status-content');
            if (!statusContent) return;
            
            let statusHTML = `<div style="font-size: 24px; margin-bottom: 20px; font-weight: 700;">FOC ADMIN LIVE: TEAM ${currentTeam || 'NOT SET'}</div>`;
            
            // Add shift lead and step-up lead info
            statusHTML += `<div style="margin-bottom: 20px;">`;
            statusHTML += `<div style="font-size: 16px; margin-bottom: 8px; opacity: 0.9;">Shift Lead: ${shiftLead || 'Not Set'}</div>`;
            statusHTML += `<div style="font-size: 16px; opacity: 0.9;">Step-up Lead: ${stepUpLead || 'Not Set'}</div>`;
            statusHTML += `</div>`;
            
            if (currentHour >= 7 && currentHour < 15 && scheduleData[currentTimeSlot]) {
                const data = scheduleData[currentTimeSlot];
                const skgCount = (data.skg || []).filter(eng => eng !== '').length;
                const textablesCount = (data.textables || []).filter(eng => eng !== '').length;
                
                // Get currently active out-of-ops (breaks/meetings that are happening right now)
                const activeOutOfOps = getCurrentActiveOutOfOps();
                const userBreaksCount = activeOutOfOps.filter(input => input.type === 'break').length;
                const userMeetingsCount = activeOutOfOps.filter(input => input.type === 'meeting').length;
                
                statusHTML += `<div class="status-grid">`;
                statusHTML += `<div class="status-item">`;
                statusHTML += `<div style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">üìä CURRENT SLOT: ${currentTimeSlot}</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üîç SKG: ${skgCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üìù Textables: ${textablesCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">‚òï Active Breaks: ${userBreaksCount} Engineers</div>`;
                statusHTML += `<div style="margin-bottom: 8px;">üìÖ Active Meetings: ${userMeetingsCount} Engineers</div>`;
                statusHTML += `</div>`;
                
                statusHTML += `<div class="status-item">`;
                statusHTML += `<div style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">üë• DASHBOARD STATS</div>`;
                statusHTML += `<div style="font-size: 14px; line-height: 1.5;">`;
                statusHTML += `Total Active: ${skgCount + textablesCount} Engineers<br>`;
                statusHTML += `Total Out of OPS: ${userMeetingsCount + userBreaksCount} Engineers<br>`;
                statusHTML += `Dashboard Users: ${Object.keys(userInputs || {}).length} Inputs`;
                statusHTML += `</div>`;
                statusHTML += `</div>`;
                statusHTML += `</div>`;
            } else {
                statusHTML += `<div style="font-size: 18px; opacity: 0.8;">Outside operational hours (7:00-15:00) or no schedule data</div>`;
            }
            
            statusContent.innerHTML = statusHTML;
        }
        
        function getCurrentActiveOutOfOps() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            return Object.values(userInputs || {}).filter(input => {
                if (input.type !== 'break' && input.type !== 'meeting') return false;
                
                const startMinutes = timeToMinutes(input.timeSlot);
                const durationMinutes = parseInt(input.duration.replace(' minutes', ''));
                const endMinutes = startMinutes + durationMinutes;
                
                return currentMinutes >= startMinutes && currentMinutes < endMinutes;
            });
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function startTimeClock() {
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-GB', {
                    hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                const timeElement = document.getElementById('current-time');
                if (timeElement) timeElement.textContent = `Current Time: ${timeString}`;
                
                const currentHour = now.getHours();
                let currentTimeSlot = '';
                
                if (currentHour >= 7 && currentHour < 15) {
                    currentTimeSlot = `${currentHour}:00`;
                }
                
                document.querySelectorAll('.time-indicator').forEach(el => {
                    el.classList.remove('time-indicator');
                });
                
                if (currentTimeSlot) {
                    const rows = document.querySelectorAll('#schedule-tbody tr');
                    rows.forEach(row => {
                        const timeCell = row.cells[0];
                        if (timeCell && timeCell.textContent.trim().includes(currentHour + ':00')) {
                            row.classList.add('time-indicator');
                        }
                    });
                }
                
                if (now.getSeconds() === 0) updateLiveStatus();
            }
            
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(updateLiveStatus, 5000); // Update live status every 5 seconds
        }

        // Global functions
        window.updateScheduleData = function(time, type, index, value) {
            updateUserActivity(); // Track user activity
            
            if (type.includes('skg') && value && isEngineerAssigned(time, value, 'textables')) {
                alert('Engineers cannot be assigned to both SKG and Textables.');
                event.target.value = '';
                return;
            }
            if (type.includes('textables') && value && isEngineerAssigned(time, value, 'skg')) {
                alert('Engineers cannot be assigned to both SKG and Textables.');
                event.target.value = '';
                return;
            }
            
            const oldValue = scheduleData[time][type][index];
            scheduleData[time][type][index] = value;
            
            // Add to edit history
            if (value && value !== oldValue) {
                addToEditHistory('Schedule Update', `Assigned ${value} to ${type.toUpperCase()} at ${time}`);
            } else if (!value && oldValue) {
                addToEditHistory('Schedule Update', `Removed ${oldValue} from ${type.toUpperCase()} at ${time}`);
            }
            
            updateLiveStatus();
            syncToFirebase();
        };

        window.addExtraEngineer = function() {
            updateUserActivity(); // Track user activity
            
            const select = document.getElementById('extra-engineer-select');
            const engineer = select.value;
            if (engineer && !extraEngineers.includes(engineer)) {
                extraEngineers.push(engineer);
                updateAvailableEngineers();
                updateExtraEngineersDisplay();
                updateScheduleTable();
                select.value = '';
                syncToFirebase();
            }
        };

        window.removeExtraEngineer = function(engineer) {
            extraEngineers = extraEngineers.filter(eng => eng !== engineer);
            updateAvailableEngineers();
            updateExtraEngineersDisplay();
            updateScheduleTable();
            syncToFirebase();
        };

        window.addEngineerOff = function() {
            const select = document.getElementById('engineer-off-select');
            const engineer = select.value;
            if (engineer && !engineersOff.includes(engineer)) {
                engineersOff.push(engineer);
                updateEngineersOffDisplay();
                updateScheduleTable();
                select.value = '';
                syncToFirebase();
            }
        };

        window.removeEngineerOff = function(engineer) {
            engineersOff = engineersOff.filter(eng => eng !== engineer);
            updateEngineersOffDisplay();
            updateScheduleTable();
            syncToFirebase();
        };

        function updateExtraEngineersDisplay() {
            const container = document.getElementById('extra-engineers-list');
            if (container) {
                container.innerHTML = extraEngineers.map(eng => 
                    `<span style="margin: 4px; padding: 8px 12px; background: rgba(0,122,255,0.1); border-radius: 12px; display: inline-block; font-size: 14px; color: var(--text-primary);">
                        ${eng} <button onclick="removeExtraEngineer('${eng}')" style="background: #ff3b30; color: white; border: none; border-radius: 6px; margin-left: 8px; cursor: pointer; padding: 2px 6px;">√ó</button>
                    </span>`
                ).join('');
            }
        }

        function updateEngineersOffDisplay() {
            const container = document.getElementById('engineers-off-list');
            if (container) {
                container.innerHTML = engineersOff.map(eng => 
                    `<span style="margin: 4px; padding: 8px 12px; background: rgba(255,59,48,0.1); border-radius: 12px; display: inline-block; font-size: 14px; color: var(--text-primary);">
                        ${eng} <button onclick="removeEngineerOff('${eng}')" style="background: #ff3b30; color: white; border: none; border-radius: 6px; margin-left: 8px; cursor: pointer; padding: 2px 6px;">√ó</button>
                    </span>`
                ).join('');
            }
        }

        function removeUserInput(key) {
            if (confirm('Are you sure you want to remove this break/meeting?')) {
                if (firebaseInitialized) {
                    userInputsRef.child(key).remove().then(() => {
                        console.log('User input removed successfully');
                        updateLiveStatus(); // Immediately update live status
                    }).catch(err => console.log('Remove failed:', err));
                } else {
                    delete userInputs[key];
                    updateUserInputsDisplay();
                    updateLiveStatus();
                }
            }
        }
        
        function logout() {
            // Remove from viewer tracking
            if (myViewerRef) {
                myViewerRef.remove();
                myViewerRef = null;
            }
            
            isAuthenticated = false;
            currentUsername = '';
            showLogin();
        }
        
        // Theme toggle functionality
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDarkMode);
        }
        
        function initTheme() {
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            if (document.querySelector('.theme-toggle')) {
                document.querySelector('.theme-toggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            if (isAuthenticated) {
                initDashboard();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
